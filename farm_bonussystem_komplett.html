<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farm Bonussystem - Komplett - Namibia Rinderfarm</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1F4E78 0%, #2E75B6 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
        }

        .header-logo {
            width: 120px;
            height: 120px;
            filter: brightness(0) invert(1);
            opacity: 0.9;
        }

        .header-content {
            flex: 1;
            max-width: 800px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }
            .header-logo {
                width: 80px;
                height: 80px;
            }
            .header h1 {
                font-size: 1.8em;
            }
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        
        .tab {
            flex: 1;
            padding: 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            color: #495057;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab:hover {
            background: rgba(68, 114, 196, 0.1);
        }
        
        .tab.active {
            color: #2E75B6;
            background: white;
            border-bottom: 3px solid #2E75B6;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }
        
        .input-section, .output-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #dee2e6;
        }
        
        h2 {
            color: #2E75B6;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #2E75B6;
            font-size: 1.5em;
        }
        
        h3 {
            color: #4472C4;
            margin-top: 20px;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .input-group {
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 600;
            font-size: 0.95em;
        }
        
        input[type="number"], input[type="range"], select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ced4da;
            border-radius: 6px;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #4472C4;
            box-shadow: 0 0 0 3px rgba(68, 114, 196, 0.1);
        }
        
        input[type="range"] {
            -webkit-appearance: none;
            height: 8px;
            background: #ddd;
            outline: none;
            border: none;
            padding: 0;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #4472C4;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #4472C4;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .range-value {
            display: inline-block;
            margin-left: 10px;
            padding: 5px 10px;
            background: #4472C4;
            color: white;
            border-radius: 4px;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
        }
        
        .result-box {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            border-left: 5px solid #4472C4;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .result-box h4 {
            color: #2E75B6;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }
        
        .result-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .result-label {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .result-value {
            color: #2E75B6;
            font-size: 1.3em;
            font-weight: bold;
        }
        
        .highlight-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .highlight-box h4 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        
        .total-bonus {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .percentage {
            font-size: 1.5em;
            opacity: 0.9;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        th {
            background: #4472C4;
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #28a745;
        }
        
        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #ffc107;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            margin-bottom: 30px;
            height: 500px;
        }
        
        .control-panel {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #dee2e6;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .info-box strong {
            color: #1976D2;
        }

        .export-controls {
            display: flex;
            gap: 10px;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        input[type="file"] {
            display: none;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            margin-left: 5px;
            width: 18px;
            height: 18px;
            line-height: 18px;
            text-align: center;
            background: #4472C4;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background-color: #2E75B6;
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 13px;
            line-height: 1.5;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -8px;
            border-width: 8px;
            border-style: solid;
            border-color: #2E75B6 transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .tooltip .tooltiptext {
                width: 220px;
                margin-left: -110px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <svg class="header-logo" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <!-- Cow silhouette -->
                <g fill="currentColor">
                    <!-- Body -->
                    <ellipse cx="100" cy="110" rx="70" ry="45"/>
                    <!-- Head -->
                    <ellipse cx="45" cy="85" rx="35" ry="30"/>
                    <!-- Snout -->
                    <ellipse cx="25" cy="85" rx="15" ry="12"/>
                    <!-- Ears -->
                    <ellipse cx="35" cy="65" rx="8" ry="15" transform="rotate(-20 35 65)"/>
                    <ellipse cx="55" cy="65" rx="8" ry="15" transform="rotate(20 55 65)"/>
                    <!-- Legs -->
                    <rect x="60" y="145" width="12" height="40" rx="6"/>
                    <rect x="85" y="145" width="12" height="40" rx="6"/>
                    <rect x="110" y="145" width="12" height="40" rx="6"/>
                    <rect x="135" y="145" width="12" height="40" rx="6"/>
                    <!-- Tail -->
                    <path d="M 165 115 Q 185 105 180 85" stroke="currentColor" stroke-width="6" fill="none" stroke-linecap="round"/>
                    <!-- Spots -->
                    <ellipse cx="90" cy="95" rx="15" ry="12" opacity="0.3"/>
                    <ellipse cx="125" cy="105" rx="18" ry="14" opacity="0.3"/>
                    <ellipse cx="110" cy="125" rx="12" ry="10" opacity="0.3"/>
                </g>
            </svg>
            <div class="header-content">
                <h1>Farm Bonussystem Komplett</h1>
                <p>Rinderfarm Namibia - Integriertes Bonus-Analyse System</p>
            </div>
            <svg class="header-logo" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <!-- Cow silhouette (mirrored) -->
                <g fill="currentColor" transform="scale(-1, 1) translate(-200, 0)">
                    <!-- Body -->
                    <ellipse cx="100" cy="110" rx="70" ry="45"/>
                    <!-- Head -->
                    <ellipse cx="45" cy="85" rx="35" ry="30"/>
                    <!-- Snout -->
                    <ellipse cx="25" cy="85" rx="15" ry="12"/>
                    <!-- Ears -->
                    <ellipse cx="35" cy="65" rx="8" ry="15" transform="rotate(-20 35 65)"/>
                    <ellipse cx="55" cy="65" rx="8" ry="15" transform="rotate(20 55 65)"/>
                    <!-- Legs -->
                    <rect x="60" y="145" width="12" height="40" rx="6"/>
                    <rect x="85" y="145" width="12" height="40" rx="6"/>
                    <rect x="110" y="145" width="12" height="40" rx="6"/>
                    <rect x="135" y="145" width="12" height="40" rx="6"/>
                    <!-- Tail -->
                    <path d="M 165 115 Q 185 105 180 85" stroke="currentColor" stroke-width="6" fill="none" stroke-linecap="round"/>
                    <!-- Spots -->
                    <ellipse cx="90" cy="95" rx="15" ry="12" opacity="0.3"/>
                    <ellipse cx="125" cy="105" rx="18" ry="14" opacity="0.3"/>
                    <ellipse cx="110" cy="125" rx="12" ry="10" opacity="0.3"/>
                </g>
            </svg>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('ebit')">üìä EBIT Berechnung</button>
            <button class="tab" onclick="switchTab('bonus')">üí∞ Bonusberechnung</button>
            <button class="tab" onclick="switchTab('overview')">üéØ Zielwert-√úbersicht</button>
            <button class="tab" onclick="switchTab('info')">‚ÑπÔ∏è Info & Hilfe</button>
        </div>

        <div class="export-controls">
            <button class="btn btn-primary" onclick="exportToJSON()" title="Speichert alle aktuellen Parameter als JSON-Datei. Perfekt um verschiedene Szenarien zu vergleichen.">üíæ JSON Export</button>
            <button class="btn btn-secondary" onclick="document.getElementById('jsonFileInput').click()" title="L√§dt zuvor gespeicherte Parameter aus einer JSON-Datei.">üìÅ JSON Import</button>
            <input type="file" id="jsonFileInput" accept=".json" onchange="importFromJSON(event)">
            <button class="btn btn-success" onclick="exportToPDF()" title="Erstellt einen professionellen PDF-Bericht mit allen Berechnungen zum Ausdrucken oder Teilen.">üìÑ PDF Export</button>
            <div style="flex: 1;"></div>
            <span style="display: flex; align-items: center; color: #6c757d; font-size: 0.9em;" title="Ihre Eingaben werden automatisch im Browser gespeichert und beim n√§chsten √ñffnen wiederhergestellt.">
                üíæ Auto-Save aktiv
            </span>
        </div>
        
        <!-- TAB 1: EBIT BERECHNUNG -->
        <div id="ebit" class="tab-content active">
            <div class="main-content">
                <div class="input-section">
                    <h2>üì• EBIT Berechnung - Eingaben</h2>
                    
                    <h3>üêÑ Herdenparameter</h3>
                    <div class="input-group">
                        <label>Herdengr√∂√üe: <span class="range-value" id="herdSizeValue">800</span>
                            <span class="tooltip">?
                                <span class="tooltiptext">Gesamtzahl der Tiere auf der Farm. Standardwert f√ºr namibische Rinderfarmen: 800-1.200 Tiere.</span>
                            </span>
                        </label>
                        <input type="range" id="herdSize" min="400" max="1500" value="800" oninput="updateValue('herdSize'); calculate()">
                    </div>

                    <div class="input-group">
                        <label>Schlachtgewicht pro Tier (kg): <span class="range-value" id="slaughterWeightValue">225</span>
                            <span class="tooltip">?
                                <span class="tooltiptext">Durchschnittliches Gewicht eines verkauften Tieres nach der Schlachtung. Typ. 180-280 kg in Namibia.</span>
                            </span>
                        </label>
                        <input type="range" id="slaughterWeight" min="180" max="280" value="225" oninput="updateValue('slaughterWeight'); calculate()">
                    </div>

                    <div class="input-group">
                        <label>Verkaufsrate (%): <span class="range-value" id="salesRateValue">26%</span>
                            <span class="tooltip">?
                                <span class="tooltiptext">Prozentsatz der Herde, der j√§hrlich verkauft wird. Typ. 20-30% f√ºr nachhaltige Bewirtschaftung.</span>
                            </span>
                        </label>
                        <input type="range" id="salesRate" min="15" max="40" value="26" step="0.5" oninput="updateValue('salesRate'); calculate()">
                    </div>

                    <div class="input-group">
                        <label for="pricePerKg">Preis pro kg Schlachtgewicht (N$)
                            <span class="tooltip">?
                                <span class="tooltiptext">Verkaufspreis pro Kilogramm Schlachtgewicht in Namibia-Dollar. Marktpreis variiert je nach Qualit√§t und Nachfrage.</span>
                            </span>
                        </label>
                        <input type="number" id="pricePerKg" value="60" step="1" oninput="calculate()">
                    </div>
                    
                    <h3>üí∞ Sonstige Einnahmen</h3>
                    <div class="input-group">
                        <label for="huntingRevenue">Jagd Einnahmen (N$)
                            <span class="tooltip">?
                                <span class="tooltiptext">Einnahmen aus Jagdlizenzen oder Troph√§enjagd auf dem Farmgel√§nde.</span>
                            </span>
                        </label>
                        <input type="text" id="huntingRevenue" value="0" oninput="formatInput(this); calculate()">
                    </div>

                    <div class="input-group">
                        <label for="rentRevenue">Pacht Einnahmen (N$)
                            <span class="tooltip">?
                                <span class="tooltiptext">Einnahmen aus Verpachtung von Land oder Weidefl√§chen an andere Farmer.</span>
                            </span>
                        </label>
                        <input type="text" id="rentRevenue" value="0" oninput="formatInput(this); calculate()">
                    </div>

                    <div class="input-group">
                        <label for="otherRevenue">Sonstige Einnahmen (N$)
                            <span class="tooltip">?
                                <span class="tooltiptext">Andere Einnahmen wie Verkauf von Fellen, Nebenprodukte, etc.</span>
                            </span>
                        </label>
                        <input type="text" id="otherRevenue" value="0" oninput="formatInput(this); calculate()">
                    </div>

                    <h3>üí∏ Kosten</h3>
                    <div class="input-group">
                        <label for="baseCosts">Betriebskosten (N$)
                            <span class="tooltip">?
                                <span class="tooltiptext">Gesamte j√§hrliche Betriebskosten: Personal, Futter, Veterin√§r, Instandhaltung, Wasser, Strom, etc.</span>
                            </span>
                        </label>
                        <input type="text" id="baseCosts" value="2.000.000" oninput="formatInput(this); calculate()">
                    </div>
                </div>
                
                <div class="output-section">
                    <h2>üìä EBIT Ergebnisse</h2>
                    
                    <div class="result-box">
                        <h4>üêÑ Herdenkennzahlen</h4>
                        <div class="result-grid">
                            <div class="result-item">
                                <div class="result-label">Herdengr√∂√üe</div>
                                <div class="result-value" id="displayHerdSize">800 Tiere</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">Verkaufte Tiere</div>
                                <div class="result-value" id="soldAnimals">208</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">Schlachtgewicht Total</div>
                                <div class="result-value" id="totalWeight">46.800 kg</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">√ò Schlachtgewicht/Tier</div>
                                <div class="result-value" id="avgWeight">225 kg</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="result-box">
                        <h4>üíµ Einnahmen & Kosten</h4>
                        <table>
                            <tr>
                                <td><strong>Viehverkauf</strong></td>
                                <td style="text-align: right;"><strong id="cattleRevenue">0 N$</strong></td>
                            </tr>
                            <tr>
                                <td>‚îî Verkaufte Tiere</td>
                                <td style="text-align: right; font-size: 0.9em; color: #6c757d;" id="soldAnimalsDetail">0 √ó 225 kg √ó 60 N$/kg</td>
                            </tr>
                            <tr>
                                <td>Jagd Einnahmen</td>
                                <td style="text-align: right;" id="displayHunting">0 N$</td>
                            </tr>
                            <tr>
                                <td>Pacht Einnahmen</td>
                                <td style="text-align: right;" id="displayRent">0 N$</td>
                            </tr>
                            <tr>
                                <td>Sonstige Einnahmen</td>
                                <td style="text-align: right;" id="displayOther">0 N$</td>
                            </tr>
                            <tr style="background: #e8f5e9; font-weight: bold;">
                                <td><strong>Gesamteinnahmen</strong></td>
                                <td style="text-align: right;"><strong id="totalRevenue">0 N$</strong></td>
                            </tr>
                            <tr>
                                <td colspan="2" style="height: 10px;"></td>
                            </tr>
                            <tr>
                                <td><strong>Betriebskosten</strong></td>
                                <td style="text-align: right;" id="totalCost">0 N$</td>
                            </tr>
                            <tr>
                                <td colspan="2" style="height: 10px; border-bottom: 2px solid #dee2e6;"></td>
                            </tr>
                            <tr style="background: #fff3cd; font-weight: bold; font-size: 1.2em;">
                                <td><strong>EBIT</strong></td>
                                <td style="text-align: right; color: #28a745;"><strong id="ebitAmount">0 N$</strong></td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="info-box">
                        <strong>‚ÑπÔ∏è EBIT Berechnung:</strong> EBIT (Earnings Before Interest and Taxes) = Gesamteinnahmen - Betriebskosten. 
                        Dies ist die Grundlage f√ºr die Bonusberechnung im n√§chsten Tab.
                    </div>
                    
                    <div id="statusMessageEbit" class="success">
                        <strong>‚úÖ Status:</strong> EBIT Berechnung aktualisiert
                    </div>
                </div>
            </div>
        </div>
        
        <!-- TAB 2: BONUSBERECHNUNG -->
        <div id="bonus" class="tab-content">
            <div class="main-content">
                <div class="input-section">
                    <h2>‚öôÔ∏è Bonus Parameter</h2>
                    
                    <div class="result-box" style="background: #e3f2fd; border-left: 5px solid #2196F3;">
                        <h4>üíµ Aktueller EBIT</h4>
                        <div style="font-size: 2em; font-weight: bold; color: #1976D2; text-align: center; padding: 10px;" id="ebitDisplayBonus">0 N$</div>
                    </div>
                    
                    <h3>üìä EBIT Bonus-Staffelung (70% Gewichtung)</h3>
                    <div class="input-group">
                        <label>Stufe 1 (0-100k): <span class="range-value" id="tier1RateValue">8%</span></label>
                        <input type="range" id="tier1Rate" min="0" max="20" step="0.5" value="8" oninput="updateValue('tier1Rate'); calculate()">
                    </div>
                    
                    <div class="input-group">
                        <label>Stufe 2 (100k-500k): <span class="range-value" id="tier2RateValue">12%</span></label>
                        <input type="range" id="tier2Rate" min="0" max="25" step="0.5" value="12" oninput="updateValue('tier2Rate'); calculate()">
                    </div>
                    
                    <div class="input-group">
                        <label>Stufe 3 (500k-2M): <span class="range-value" id="tier3RateValue">15%</span></label>
                        <input type="range" id="tier3Rate" min="0" max="30" step="0.5" value="15" oninput="updateValue('tier3Rate'); calculate()">
                    </div>
                    
                    <div class="input-group">
                        <label>Stufe 4 (2M+): <span class="range-value" id="tier4RateValue">20%</span></label>
                        <input type="range" id="tier4Rate" min="0" max="35" step="0.5" value="20" oninput="updateValue('tier4Rate'); calculate()">
                    </div>
                    
                    <div class="input-group">
                        <label>EBIT Cap (Mio N$): <span class="range-value" id="ebitCapValue">4.0M</span></label>
                        <input type="range" id="ebitCap" min="1" max="10" step="0.5" value="4" oninput="updateValue('ebitCap'); calculate()">
                    </div>
                    
                    <h3>üìä Produktivit√§tsindex (30% Gewichtung)</h3>
                    
                    <div class="result-box" style="background: #fff3e0; border-left: 5px solid #ff9800;">
                        <h4>üìà Automatische Berechnung</h4>
                        <div style="padding: 10px; background: white; border-radius: 5px; margin-top: 10px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <div>
                                    <div style="font-size: 0.9em; color: #6c757d;">kg Schlachtgewicht verkauft</div>
                                    <div style="font-size: 1.2em; font-weight: bold; color: #ff9800;" id="totalKgSold">0 kg</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.9em; color: #6c757d;">Gesamtkosten</div>
                                    <div style="font-size: 1.2em; font-weight: bold; color: #ff9800;" id="totalCostsProd">0 N$</div>
                                </div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #fff3e0; border-radius: 5px;">
                                <div style="font-size: 0.9em; color: #6c757d; margin-bottom: 5px;">Produktivit√§tsindex</div>
                                <div style="font-size: 2em; font-weight: bold; color: #ff6f00;" id="prodIndexValue">0.0</div>
                                <div style="font-size: 0.85em; color: #6c757d; margin-top: 5px;">kg pro 1.000 N$ Kosten</div>
                            </div>
                            <div style="margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 5px; text-align: center;">
                                <div style="font-size: 0.9em; color: #6c757d;">Bewertung</div>
                                <div style="font-size: 1.1em; font-weight: bold; color: #2e7d32;" id="prodRating">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-box" style="background: #e3f2fd; border-left: 4px solid #2196f3;">
                        <strong>‚ÑπÔ∏è Richtwerte Namibia:</strong><br>
                        &lt; 15 = Kritisch (Verlustzone)<br>
                        15-20 = Basis (Verbesserung n√∂tig)<br>
                        20-25 = Gut (Namibia-Standard)<br>
                        &gt; 25 = Exzellent (Top 20%)
                    </div>
                    
                    <h3>üë• Personal</h3>
                    <div class="input-group">
                        <label for="baseSalary">Grundgehalt Verwalter (N$)
                            <span class="tooltip">?
                                <span class="tooltiptext">J√§hrliches Festgehalt des Farm-Verwalters/Managers ohne Bonus.</span>
                            </span>
                        </label>
                        <input type="text" id="baseSalary" value="700.000" oninput="formatInput(this); calculate()">
                    </div>

                    <h3>üéØ Skin in the Game</h3>
                    <div class="input-group">
                        <label>Investment (N$): <span class="range-value" id="investmentValue">0</span>
                            <span class="tooltip">?
                                <span class="tooltiptext">Eigenes Investment des Managers in die Farm (max. 140.000 N$). Erh√∂ht den Bonus-Multiplikator und wird verzinst.</span>
                            </span>
                        </label>
                        <input type="range" id="investment" min="0" max="200000" step="10000" value="0" oninput="updateValue('investment'); calculate()">
                    </div>

                    <div class="input-group">
                        <label>Max Multiplikator: <span class="range-value" id="multiplierMaxValue">1.6x</span>
                            <span class="tooltip">?
                                <span class="tooltiptext">Maximaler Bonus-Multiplikator bei vollem Investment (140.000 N$). Bei 0 Investment = 1,0√ó.</span>
                            </span>
                        </label>
                        <input type="range" id="multiplierMax" min="1" max="3" step="0.1" value="1.6" oninput="updateValue('multiplierMax'); calculate()">
                    </div>

                    <div class="input-group">
                        <label>Basis-Zinssatz: <span class="range-value" id="baseInterestValue">8%</span>
                            <span class="tooltip">?
                                <span class="tooltiptext">J√§hrliche Verzinsung des Manager-Investments. Wird zus√§tzlich zum Bonus ausgezahlt.</span>
                            </span>
                        </label>
                        <input type="range" id="baseInterest" min="0" max="15" step="0.5" value="8" oninput="updateValue('baseInterest'); calculate()">
                    </div>

                    <h3>üè¶ Auszahlungsstruktur</h3>
                    <div class="input-group">
                        <label>Sofort-Auszahlung: <span class="range-value" id="immediatePaymentValue">60%</span>
                            <span class="tooltip">?
                                <span class="tooltiptext">Prozentsatz des Bonus, der sofort ausgezahlt wird. Der Rest geht in die 3-Jahres Bonus Bank.</span>
                            </span>
                        </label>
                        <input type="range" id="immediatePayment" min="0" max="100" step="5" value="60" oninput="updateValue('immediatePayment'); calculate()">
                    </div>
                </div>
                
                <div class="output-section">
                    <h2>üí∞ Bonus Ergebnisse</h2>
                    
                    <div class="result-box">
                        <h4>üíé EBIT Bonus - S√§ule 1 (Progressive Berechnung)</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>Stufe</th>
                                    <th>EBIT Betrag</th>
                                    <th>Rate</th>
                                    <th>Bonus</th>
                                </tr>
                            </thead>
                            <tbody id="ebitBreakdown">
                            </tbody>
                        </table>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #dee2e6;">
                            <table>
                                <tr style="background: #f0f8ff;">
                                    <td><strong>EBIT Bonus Total (ungewichtet)</strong></td>
                                    <td style="text-align: right;"><strong id="ebitBonusRaw">0 N$</strong></td>
                                </tr>
                                <tr style="background: #e3f2fd; font-weight: bold;">
                                    <td><strong>EBIT Bonus (70% gewichtet)</strong></td>
                                    <td style="text-align: right;"><strong id="ebitBonus">0 N$</strong></td>
                                </tr>
                            </table>
                        </div>
                        <div class="info-box">
                            <strong>‚ÑπÔ∏è Progressive Berechnung:</strong> Der Bonus wird stufeweise berechnet, √§hnlich wie Einkommenssteuer. 
                            Jede EBIT-Stufe wird mit ihrem eigenen Prozentsatz berechnet, dann mit 70% gewichtet.
                        </div>
                    </div>
                    
                    <div class="result-box">
                        <h4>üìä Produktivit√§tsbonus - S√§ule 2</h4>
                        <div style="margin-bottom: 15px; padding: 15px; background: #fff3e0; border-radius: 5px;">
                            <table style="width: 100%;">
                                <tr>
                                    <td>Produktivit√§tsindex</td>
                                    <td style="text-align: right;"><strong id="prodIndexDisplay">0.0</strong></td>
                                </tr>
                                <tr>
                                    <td>Bewertung</td>
                                    <td style="text-align: right;" id="prodRatingDisplay">-</td>
                                </tr>
                                <tr>
                                    <td>Bonus-Faktor</td>
                                    <td style="text-align: right;"><strong id="prodFactorDisplay">0.0x</strong></td>
                                </tr>
                            </table>
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #dee2e6;">
                            <table>
                                <tr style="background: #f0f8ff;">
                                    <td><strong>EBIT Bonus Total (ungewichtet)</strong></td>
                                    <td style="text-align: right;"><strong id="ebitBonusRawProd">0 N$</strong></td>
                                </tr>
                                <tr>
                                    <td>30% Basis (bei Faktor 1,0)</td>
                                    <td style="text-align: right;" id="prodBonusBase">0 N$</td>
                                </tr>
                                <tr>
                                    <td>√ó Produktivit√§ts-Faktor</td>
                                    <td style="text-align: right;" id="prodFactorCalc">√ó 0.0</td>
                                </tr>
                                <tr style="background: #e3f2fd; font-weight: bold;">
                                    <td><strong>Produktivit√§tsbonus (gewichtet)</strong></td>
                                    <td style="text-align: right;"><strong id="prodBonus">0 N$</strong></td>
                                </tr>
                            </table>
                        </div>
                        <div class="info-box">
                            <strong>‚ÑπÔ∏è Berechnung:</strong> Bei Faktor 1,0 sind 30% vom ungewichteten EBIT-Bonus der Produktivit√§tsbonus. 
                            Der Faktor wird basierend auf dem Produktivit√§tsindex angewendet (0√ó / 1√ó / 1,5√ó / 2√ó).
                        </div>
                    </div>
                    
                    <div class="result-box">
                        <h4>üéØ Skin in the Game Effekt</h4>
                        <table>
                            <tr>
                                <td>Basis-Bonus (EBIT 70% + Prod 30%)</td>
                                <td style="text-align: right;" id="subtotal">0 N$</td>
                            </tr>
                            <tr>
                                <td>Investment</td>
                                <td style="text-align: right;" id="investmentDisplay">0 N$</td>
                            </tr>
                            <tr>
                                <td>Multiplikator</td>
                                <td style="text-align: right;" id="multiplierCalc">1.0x</td>
                            </tr>
                            <tr style="background: #f0f8ff;">
                                <td><strong>Bonus nach Multiplikator</strong></td>
                                <td style="text-align: right;"><strong id="multiplierBonus">0 N$</strong></td>
                            </tr>
                            <tr>
                                <td>+ Zinsen auf Investment</td>
                                <td style="text-align: right;" id="interestAmount">0 N$</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="highlight-box">
                        <h4>üí∞ GESAMTBONUS</h4>
                        <div class="total-bonus" id="totalBonus">0 N$</div>
                        <div class="percentage" id="bonusPercentage">0% vom Grundgehalt</div>
                        <hr style="margin: 15px 0; border: none; border-top: 1px solid rgba(255,255,255,0.3);">
                        <div class="result-grid">
                            <div>
                                <div style="opacity: 0.9; font-size: 0.9em;">Sofort-Auszahlung</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="immediateAmount">0 N$</div>
                            </div>
                            <div>
                                <div style="opacity: 0.9; font-size: 0.9em;">Bonus Bank (3 Jahre)</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="bankAmount">0 N$</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="statusMessage" class="success">
                        <strong>‚úÖ Status:</strong> Bonus-Berechnung aktualisiert
                    </div>
                </div>
            </div>
        </div>
        
        <!-- TAB 3: ZIELWERT-√úBERSICHT -->
        <div id="overview" class="tab-content">
            <div style="padding: 30px;">
                <h2>üéØ Zielwert-√úbersicht & Benchmarks</h2>

                <div class="result-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                    <h4 style="color: white;">üí° Aktuelle Situation</h4>
                    <div class="stats-grid" style="margin-top: 15px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                            <div style="opacity: 0.9; font-size: 0.9em;">Aktueller EBIT</div>
                            <div style="font-size: 1.8em; font-weight: bold;" id="overviewCurrentEbit">0 N$</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                            <div style="opacity: 0.9; font-size: 0.9em;">Produktivit√§tsindex</div>
                            <div style="font-size: 1.8em; font-weight: bold;" id="overviewProdIndex">0.0</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                            <div style="opacity: 0.9; font-size: 0.9em;">Aktueller Bonus</div>
                            <div style="font-size: 1.8em; font-weight: bold;" id="overviewCurrentBonus">0 N$</div>
                        </div>
                    </div>
                </div>

                <div class="result-box">
                    <h4>üéØ EBIT Zielwerte & Bonus-Potenzial</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Ziel</th>
                                <th>EBIT ben√∂tigt</th>
                                <th>EBIT Bonus (70%)</th>
                                <th>Total Bonus (gesch√§tzt)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr id="target-entry">
                                <td><strong>Einstieg Bonussystem</strong></td>
                                <td id="targetEntry">100.000 N$</td>
                                <td id="targetEntryBonus">8.000 N$</td>
                                <td id="targetEntryTotal">~11.000 N$</td>
                                <td id="targetEntryStatus">‚ùå</td>
                            </tr>
                            <tr id="target-tier2">
                                <td><strong>Tier 2 erreichen</strong></td>
                                <td id="targetTier2">500.000 N$</td>
                                <td id="targetTier2Bonus">56.000 N$</td>
                                <td id="targetTier2Total">~80.000 N$</td>
                                <td id="targetTier2Status">‚ùå</td>
                            </tr>
                            <tr id="target-tier3">
                                <td><strong>Tier 3 erreichen</strong></td>
                                <td id="targetTier3">2.000.000 N$</td>
                                <td id="targetTier3Bonus">281.000 N$</td>
                                <td id="targetTier3Total">~400.000 N$</td>
                                <td id="targetTier3Status">‚ùå</td>
                            </tr>
                            <tr id="target-max">
                                <td><strong>Maximum erreichen</strong></td>
                                <td id="targetMax">4.000.000 N$</td>
                                <td id="targetMaxBonus">681.000 N$</td>
                                <td id="targetMaxTotal">~970.000 N$</td>
                                <td id="targetMaxStatus">‚ùå</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="info-box">
                        <strong>‚ÑπÔ∏è Hinweis:</strong> "Total Bonus" ist eine Sch√§tzung basierend auf durchschnittlichem Produktivit√§tsindex (1,5√ó Faktor) und ohne Skin in the Game Investment.
                    </div>
                </div>

                <div class="result-box">
                    <h4>üìä Produktivit√§tsindex Ziele</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Stufe</th>
                                <th>Index-Bereich</th>
                                <th>Bonus-Faktor</th>
                                <th>Ben√∂tigt bei aktuellen Kosten</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr id="prod-critical">
                                <td>üî¥ Kritisch</td>
                                <td>&lt; 15</td>
                                <td>0√ó (Kein Produktivit√§tsbonus)</td>
                                <td id="prodCritical">-</td>
                                <td id="prodCriticalStatus">-</td>
                            </tr>
                            <tr id="prod-basis">
                                <td>üü° Basis</td>
                                <td>15 - 20</td>
                                <td>1√ó (30% Basis-Produktivit√§tsbonus)</td>
                                <td id="prodBasis">-</td>
                                <td id="prodBasisStatus">-</td>
                            </tr>
                            <tr id="prod-good">
                                <td>üü¢ Gut</td>
                                <td>20 - 25</td>
                                <td>1,5√ó (45% vom EBIT-Bonus)</td>
                                <td id="prodGood">-</td>
                                <td id="prodGoodStatus">-</td>
                            </tr>
                            <tr id="prod-excellent">
                                <td>‚≠ê Exzellent</td>
                                <td>&gt; 25</td>
                                <td>2√ó (60% vom EBIT-Bonus)</td>
                                <td id="prodExcellent">-</td>
                                <td id="prodExcellentStatus">-</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="info-box">
                        <strong>üí° Tipp:</strong> Um den Index zu verbessern: Verkaufsgewicht erh√∂hen (mehr/schwerere Tiere verkaufen) oder Kosten senken.
                    </div>
                </div>

                <div class="result-box">
                    <h4>üöÄ Handlungsempfehlungen</h4>
                    <div id="recommendations" style="padding: 15px;">
                        <!-- Wird dynamisch bef√ºllt -->
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 4: INFO & HILFE -->
        <div id="info" class="tab-content">
            <div style="padding: 30px;">
                <h2>‚ÑπÔ∏è Farm Bonussystem - Info & Hilfe</h2>

                <div class="result-box">
                    <h4>üìò Wie funktioniert das Bonussystem?</h4>
                    <p style="line-height: 1.8;">
                        Das Farm Bonussystem basiert auf einem <strong>2-S√§ulen-Modell</strong>, das sowohl Profitabilit√§t (EBIT)
                        als auch operative Effizienz (Produktivit√§t) belohnt. Zus√§tzlich k√∂nnen Manager durch eigenes Investment
                        ("Skin in the Game") ihren Bonus multiplizieren.
                    </p>
                </div>

                <div class="result-box">
                    <h4>üèóÔ∏è S√§ule 1: EBIT Bonus (70% Gewichtung)</h4>
                    <p style="margin-bottom: 15px;"><strong>Was ist EBIT?</strong><br>
                    EBIT = Earnings Before Interest and Taxes (Gewinn vor Zinsen und Steuern)<br>
                    Berechnung: Gesamteinnahmen - Betriebskosten</p>

                    <p style="margin-bottom: 15px;"><strong>Progressive Staffelung:</strong><br>
                    Der Bonus wird <em>progressiv</em> berechnet - wie bei der Einkommenssteuer. Jede EBIT-Stufe wird mit ihrem eigenen Prozentsatz berechnet:</p>

                    <table style="margin-bottom: 15px;">
                        <tr><th>Stufe</th><th>EBIT Bereich</th><th>Rate</th><th>Max. Bonus aus Stufe</th></tr>
                        <tr><td><strong>1</strong></td><td>0 - 100.000 N$</td><td>8%</td><td>8.000 N$</td></tr>
                        <tr><td><strong>2</strong></td><td>100.000 - 500.000 N$</td><td>12%</td><td>48.000 N$</td></tr>
                        <tr><td><strong>3</strong></td><td>500.000 - 2.000.000 N$</td><td>15%</td><td>225.000 N$</td></tr>
                        <tr><td><strong>4</strong></td><td>√ºber 2.000.000 N$</td><td>20%</td><td>400.000 N$</td></tr>
                    </table>

                    <p><strong>Beispiel:</strong> Bei 1.500.000 N$ EBIT:<br>
                    ‚Ä¢ Erste 100.000 N$ √ó 8% = 8.000 N$<br>
                    ‚Ä¢ N√§chste 400.000 N$ √ó 12% = 48.000 N$<br>
                    ‚Ä¢ Verbleibende 1.000.000 N$ √ó 15% = 150.000 N$<br>
                    ‚Ä¢ <strong>Total ungewichtet: 206.000 N$</strong><br>
                    ‚Ä¢ <strong>√ó 70% Gewichtung = 144.200 N$</strong></p>
                </div>

                <div class="result-box">
                    <h4>üìä S√§ule 2: Produktivit√§tsbonus (30% Gewichtung)</h4>
                    <p style="margin-bottom: 15px;"><strong>Was ist der Produktivit√§tsindex?</strong><br>
                    Misst die Effizienz: Wie viel kg Schlachtgewicht wird pro 1.000 N$ Kosten produziert?<br>
                    <strong>Formel:</strong> (verkauftes Schlachtgewicht √∑ Gesamtkosten) √ó 1.000</p>

                    <table style="margin-bottom: 15px;">
                        <tr><th>Index</th><th>Bewertung</th><th>Bonus-Faktor</th></tr>
                        <tr><td>&lt; 15</td><td>üî¥ Kritisch</td><td>0√ó (kein Bonus)</td></tr>
                        <tr><td>15 - 20</td><td>üü° Basis</td><td>1√ó (30% vom ungew. EBIT-Bonus)</td></tr>
                        <tr><td>20 - 25</td><td>üü¢ Gut</td><td>1,5√ó (45% vom ungew. EBIT-Bonus)</td></tr>
                        <tr><td>&gt; 25</td><td>‚≠ê Exzellent</td><td>2√ó (60% vom ungew. EBIT-Bonus)</td></tr>
                    </table>

                    <p><strong>Beispiel:</strong> Bei EBIT-Bonus (ungew.) von 206.000 N$ und Index 23:<br>
                    ‚Ä¢ 30% Basis = 206.000 √ó 0,3 = 61.800 N$<br>
                    ‚Ä¢ Index 23 = "Gut" = Faktor 1,5√ó<br>
                    ‚Ä¢ <strong>Produktivit√§tsbonus: 61.800 √ó 1,5 = 92.700 N$</strong></p>
                </div>

                <div class="result-box">
                    <h4>üéØ Skin in the Game (Investment-Multiplikator)</h4>
                    <p style="margin-bottom: 15px;"><strong>Was ist das?</strong><br>
                    Manager k√∂nnen eigenes Geld in die Farm investieren und erhalten daf√ºr einen Bonus-Multiplikator.</p>

                    <p style="margin-bottom: 15px;"><strong>Berechnung:</strong><br>
                    ‚Ä¢ Bei 0 N$ Investment: Multiplikator = 1,0√ó (kein Effekt)<br>
                    ‚Ä¢ Bei 140.000 N$ Investment: Multiplikator = Maximum (z.B. 1,6√ó)<br>
                    ‚Ä¢ Linear skaliert dazwischen<br>
                    ‚Ä¢ Zus√§tzlich: Verzinsung des Investments (z.B. 8%)</p>

                    <p><strong>Beispiel:</strong><br>
                    ‚Ä¢ Basis-Bonus: 236.900 N$ (EBIT 70% + Prod 30%)<br>
                    ‚Ä¢ Investment: 70.000 N$ (= 50% von 140.000)<br>
                    ‚Ä¢ Max-Multiplikator: 1,6√ó<br>
                    ‚Ä¢ Tats√§chlicher Multiplikator: 1,0 + (0,6 √ó 0,5) = 1,3√ó<br>
                    ‚Ä¢ Bonus nach Mult.: 236.900 √ó 1,3 = 307.970 N$<br>
                    ‚Ä¢ + Zinsen: 70.000 √ó 8% = 5.600 N$<br>
                    ‚Ä¢ <strong>Total: 313.570 N$</strong></p>
                </div>

                <div class="result-box">
                    <h4>üè¶ Auszahlungsstruktur</h4>
                    <p style="margin-bottom: 15px;"><strong>Zwei Auszahlungs-Optionen:</strong></p>

                    <p><strong>1. Sofort-Auszahlung</strong> (z.B. 60%)<br>
                    Wird direkt ausgezahlt, sofort verf√ºgbar.</p>

                    <p><strong>2. Bonus Bank</strong> (z.B. 40%)<br>
                    Wird √ºber 3 Jahre gesperrt. Verhindert kurzfristiges Denken und bindet den Manager langfristig.</p>
                </div>

                <div class="result-box">
                    <h4>üíæ Daten speichern & exportieren</h4>
                    <p><strong>Auto-Save:</strong> Alle Eingaben werden automatisch im Browser gespeichert.</p>
                    <p><strong>JSON Export:</strong> Speichert Parameter als Datei - perfekt f√ºr verschiedene Szenarien.</p>
                    <p><strong>JSON Import:</strong> L√§dt gespeicherte Szenarien wieder.</p>
                    <p><strong>PDF Export:</strong> Erstellt professionellen Bericht zum Ausdrucken/Teilen.</p>
                </div>

                <div class="result-box">
                    <h4>‚ùì H√§ufige Fragen</h4>
                    <p><strong>Q: Warum progressive Staffelung?</strong><br>
                    A: Belohnt h√∂here Performance √ºberproportional, ohne bei niedrigem EBIT zu hohe Kosten zu verursachen.</p>

                    <p><strong>Q: Warum 2 S√§ulen?</strong><br>
                    A: EBIT allein belohnt nur Gewinn. Der Produktivit√§tsindex stellt sicher, dass auch Effizienz z√§hlt.</p>

                    <p><strong>Q: Was passiert bei negativem EBIT?</strong><br>
                    A: Kein Bonus wird ausgezahlt (EBIT-Bonus = 0).</p>

                    <p><strong>Q: Sind meine Daten sicher?</strong><br>
                    A: Ja! Alle Daten bleiben lokal in Ihrem Browser. Keine √úbertragung an Server.</p>
                </div>
            </div>
        </div>
    </div>

    <script>

        // ===== LocalStorage Functions =====
        function saveToLocalStorage() {
            const data = {
                herdSize: document.getElementById('herdSize').value,
                slaughterWeight: document.getElementById('slaughterWeight').value,
                salesRate: document.getElementById('salesRate').value,
                pricePerKg: document.getElementById('pricePerKg').value,
                huntingRevenue: document.getElementById('huntingRevenue').value,
                rentRevenue: document.getElementById('rentRevenue').value,
                otherRevenue: document.getElementById('otherRevenue').value,
                baseCosts: document.getElementById('baseCosts').value,
                tier1Rate: document.getElementById('tier1Rate').value,
                tier2Rate: document.getElementById('tier2Rate').value,
                tier3Rate: document.getElementById('tier3Rate').value,
                tier4Rate: document.getElementById('tier4Rate').value,
                ebitCap: document.getElementById('ebitCap').value,
                baseSalary: document.getElementById('baseSalary').value,
                investment: document.getElementById('investment').value,
                multiplierMax: document.getElementById('multiplierMax').value,
                baseInterest: document.getElementById('baseInterest').value,
                immediatePayment: document.getElementById('immediatePayment').value,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('farmBonusData', JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('farmBonusData');
            if (savedData) {
                const data = JSON.parse(savedData);
                // Restore all values
                Object.keys(data).forEach(key => {
                    if (key !== 'timestamp') {
                        const element = document.getElementById(key);
                        if (element) {
                            element.value = data[key];
                            if (element.type === 'range') {
                                updateValue(key);
                            }
                        }
                    }
                });
                return true;
            }
            return false;
        }

        // ===== JSON Export/Import Functions =====
        function exportToJSON() {
            const data = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                parameters: {
                    herdSize: document.getElementById('herdSize').value,
                    slaughterWeight: document.getElementById('slaughterWeight').value,
                    salesRate: document.getElementById('salesRate').value,
                    pricePerKg: document.getElementById('pricePerKg').value,
                    huntingRevenue: document.getElementById('huntingRevenue').value,
                    rentRevenue: document.getElementById('rentRevenue').value,
                    otherRevenue: document.getElementById('otherRevenue').value,
                    baseCosts: document.getElementById('baseCosts').value,
                    tier1Rate: document.getElementById('tier1Rate').value,
                    tier2Rate: document.getElementById('tier2Rate').value,
                    tier3Rate: document.getElementById('tier3Rate').value,
                    tier4Rate: document.getElementById('tier4Rate').value,
                    ebitCap: document.getElementById('ebitCap').value,
                    baseSalary: document.getElementById('baseSalary').value,
                    investment: document.getElementById('investment').value,
                    multiplierMax: document.getElementById('multiplierMax').value,
                    baseInterest: document.getElementById('baseInterest').value,
                    immediatePayment: document.getElementById('immediatePayment').value
                }
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `farm-bonus-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.parameters) {
                        Object.keys(data.parameters).forEach(key => {
                            const element = document.getElementById(key);
                            if (element) {
                                element.value = data.parameters[key];
                                if (element.type === 'range') {
                                    updateValue(key);
                                }
                            }
                        });
                        calculate();
                        alert('‚úÖ Daten erfolgreich importiert!');
                    }
                } catch (error) {
                    alert('‚ùå Fehler beim Importieren: ' + error.message);
                }
            };
            reader.readAsText(file);
            // Reset file input
            event.target.value = '';
        }

        // ===== PDF Export Function =====
        function parseDisplayValue(element) {
            // Parse displayed value by removing currency, spaces, and dots (German format)
            const text = element.textContent || element.innerText || '0';
            return parseFloat(text.replace(/[^\d,.-]/g, '').replace(/\./g, '').replace(',', '.')) || 0;
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');

            // Get current values
            const herdSize = parseFloat(document.getElementById('herdSize').value);
            const slaughterWeight = parseFloat(document.getElementById('slaughterWeight').value);
            const salesRate = parseFloat(document.getElementById('salesRate').value);
            const pricePerKg = parseFloat(document.getElementById('pricePerKg').value);
            const soldAnimals = Math.round(herdSize * salesRate / 100);
            const totalWeight = soldAnimals * slaughterWeight;
            const cattleRevenue = totalWeight * pricePerKg;
            const huntingRevenue = parseInput(document.getElementById('huntingRevenue'));
            const rentRevenue = parseInput(document.getElementById('rentRevenue'));
            const otherRevenue = parseInput(document.getElementById('otherRevenue'));
            const baseCosts = parseInput(document.getElementById('baseCosts'));
            const totalRevenue = cattleRevenue + huntingRevenue + rentRevenue + otherRevenue;
            const ebit = totalRevenue - baseCosts;
            const totalBonus = parseDisplayValue(document.getElementById('totalBonus'));
            const baseSalary = parseInput(document.getElementById('baseSalary'));
            const bonusPercentage = (totalBonus / baseSalary * 100).toFixed(1);
            const productivityIndex = (baseCosts > 0) ? (totalWeight / baseCosts) * 1000 : 0;

            // Get EBIT breakdown
            const ebitBonusResult = calculateEbitBonus(ebit);
            const ebitBonusRaw = ebitBonusResult.total;
            const ebitBonusWeighted = ebitBonusRaw * 0.7;

            let prodRating = "";
            let prodFactor = 0;
            if (baseCosts <= 0) {
                prodRating = "Nicht berechenbar";
                prodFactor = 0;
            } else if (productivityIndex < 15) {
                prodRating = "Kritisch";
                prodFactor = 0;
            } else if (productivityIndex <= 20) {
                prodRating = "Basis";
                prodFactor = 1.0;
            } else if (productivityIndex <= 25) {
                prodRating = "Gut";
                prodFactor = 1.5;
            } else {
                prodRating = "Exzellent";
                prodFactor = 2.0;
            }

            const prodBonusBase = ebitBonusRaw * 0.3;
            const prodBonus = prodBonusBase * prodFactor;
            const investment = parseFloat(document.getElementById('investment').value) || 0;
            const multiplier = parseFloat(document.getElementById('multiplierCalc').textContent.replace('x', ''));
            const baseInterest = parseFloat(document.getElementById('baseInterest').value) / 100;
            const interestAmount = investment * baseInterest;
            const immediateRate = parseFloat(document.getElementById('immediatePayment').value) / 100;
            const immediateAmount = totalBonus * immediateRate;
            const bankAmount = totalBonus * (1 - immediateRate);

            let y = 15;
            const leftMargin = 15;
            const rightMargin = 195;
            const pageWidth = 210;

            // ========== HEADER ==========
            doc.setFillColor(31, 78, 120);
            doc.rect(0, 0, pageWidth, 50, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(28);
            doc.setFont(undefined, 'bold');
            doc.text('FARM BONUSSYSTEM', pageWidth / 2, 20, { align: 'center' });
            doc.setFontSize(14);
            doc.text('Namibia Rinderfarm - Bonus-Bericht', pageWidth / 2, 28, { align: 'center' });
            doc.setFont(undefined, 'normal');
            doc.setFontSize(10);
            doc.text(`Berichtsdatum: ${new Date().toLocaleDateString('de-DE', { year: 'numeric', month: 'long', day: 'numeric' })}`, pageWidth / 2, 36, { align: 'center' });
            doc.text(`Berichtszeit: ${new Date().toLocaleTimeString('de-DE')}`, pageWidth / 2, 43, { align: 'center' });

            y = 60;

            // ========== EXECUTIVE SUMMARY ==========
            doc.setFillColor(102, 126, 234);
            doc.roundedRect(leftMargin, y, rightMargin - leftMargin, 35, 3, 3, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('ZUSAMMENFASSUNG', leftMargin + 5, y + 8);
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`EBIT: ${formatNumber(ebit)} N$`, leftMargin + 5, y + 16);
            doc.text(`Produktivit√§tsindex: ${productivityIndex.toFixed(1)} (${prodRating})`, leftMargin + 5, y + 23);
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(`Gesamtbonus: ${formatNumber(totalBonus)} N$`, leftMargin + 5, y + 31);

            y += 45;

            // ========== SECTION 1: HERDENKENNZAHLEN ==========
            doc.setFillColor(240, 240, 240);
            doc.rect(leftMargin, y, rightMargin - leftMargin, 8, 'F');
            doc.setTextColor(31, 78, 120);
            doc.setFontSize(13);
            doc.setFont(undefined, 'bold');
            doc.text('1. HERDENKENNZAHLEN', leftMargin + 3, y + 6);
            y += 12;

            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');

            // Table
            const herdData = [
                ['Herdengr√∂√üe', `${formatNumber(herdSize)} Tiere`],
                ['Verkaufsrate', `${salesRate}%`],
                ['Verkaufte Tiere', `${formatNumber(soldAnimals)} Tiere`],
                ['√ò Schlachtgewicht', `${formatNumber(slaughterWeight)} kg/Tier`],
                ['Total Schlachtgewicht', `${formatNumber(totalWeight)} kg`],
                ['Preis pro kg', `${formatNumber(pricePerKg)} N$`]
            ];

            herdData.forEach((row, index) => {
                if (index % 2 === 0) {
                    doc.setFillColor(250, 250, 250);
                    doc.rect(leftMargin, y, 180, 6, 'F');
                }
                doc.text(row[0], leftMargin + 3, y + 4.5);
                doc.setFont(undefined, 'bold');
                doc.text(row[1], rightMargin - 3, y + 4.5, { align: 'right' });
                doc.setFont(undefined, 'normal');
                y += 6;
            });

            y += 8;

            // ========== SECTION 2: EBIT BERECHNUNG ==========
            doc.setFillColor(240, 240, 240);
            doc.rect(leftMargin, y, rightMargin - leftMargin, 8, 'F');
            doc.setTextColor(31, 78, 120);
            doc.setFontSize(13);
            doc.setFont(undefined, 'bold');
            doc.text('2. EBIT BERECHNUNG', leftMargin + 3, y + 6);
            y += 12;

            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);

            // Einnahmen
            doc.setFont(undefined, 'bold');
            doc.text('Einnahmen:', leftMargin + 3, y);
            y += 6;
            doc.setFont(undefined, 'normal');

            const revenueData = [
                ['  Viehverkauf', formatNumber(cattleRevenue)],
                ['  Jagd', formatNumber(huntingRevenue)],
                ['  Pacht', formatNumber(rentRevenue)],
                ['  Sonstige', formatNumber(otherRevenue)]
            ];

            revenueData.forEach((row) => {
                doc.text(row[0], leftMargin + 3, y);
                doc.text(`${row[1]} N$`, rightMargin - 3, y, { align: 'right' });
                y += 5;
            });

            doc.setDrawColor(200, 200, 200);
            doc.line(leftMargin, y, rightMargin, y);
            y += 5;

            doc.setFont(undefined, 'bold');
            doc.text('Gesamteinnahmen', leftMargin + 3, y);
            doc.text(`${formatNumber(totalRevenue)} N$`, rightMargin - 3, y, { align: 'right' });
            y += 8;

            // Kosten
            doc.setFont(undefined, 'normal');
            doc.text('Betriebskosten', leftMargin + 3, y);
            doc.text(`${formatNumber(baseCosts)} N$`, rightMargin - 3, y, { align: 'right' });
            y += 6;

            // EBIT Highlight
            doc.setFillColor(212, 237, 218);
            doc.roundedRect(leftMargin, y, rightMargin - leftMargin, 12, 2, 2, 'F');
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(21, 87, 36);
            doc.text('EBIT', leftMargin + 3, y + 8);
            doc.text(`${formatNumber(ebit)} N$`, rightMargin - 3, y + 8, { align: 'right' });
            y += 18;

            // ========== SECTION 3: PRODUKTIVIT√ÑTSINDEX ==========
            doc.setFillColor(240, 240, 240);
            doc.rect(leftMargin, y, rightMargin - leftMargin, 8, 'F');
            doc.setTextColor(31, 78, 120);
            doc.setFontSize(13);
            doc.setFont(undefined, 'bold');
            doc.text('3. PRODUKTIVIT√ÑTSINDEX', leftMargin + 3, y + 6);
            y += 12;

            doc.setFillColor(255, 243, 224);
            doc.roundedRect(leftMargin, y, rightMargin - leftMargin, 20, 2, 2, 'F');
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            doc.text('Formel: (kg Schlachtgewicht √∑ Gesamtkosten) √ó 1.000', leftMargin + 3, y + 6);
            doc.text(`Berechnung: (${formatNumber(totalWeight)} √∑ ${formatNumber(baseCosts)}) √ó 1.000`, leftMargin + 3, y + 12);
            doc.setFont(undefined, 'bold');
            doc.setFontSize(11);
            doc.text(`Index: ${productivityIndex.toFixed(1)}`, leftMargin + 3, y + 18);
            doc.text(`Bewertung: ${prodRating}`, leftMargin + 60, y + 18);
            doc.text(`Faktor: ${prodFactor.toFixed(1)}√ó`, rightMargin - 30, y + 18);
            y += 26;

            // ========== SECTION 4: BONUSBERECHNUNG ==========
            doc.setFillColor(240, 240, 240);
            doc.rect(leftMargin, y, rightMargin - leftMargin, 8, 'F');
            doc.setTextColor(31, 78, 120);
            doc.setFontSize(13);
            doc.setFont(undefined, 'bold');
            doc.text('4. BONUSBERECHNUNG (2-S√ÑULEN-MODELL)', leftMargin + 3, y + 6);
            y += 14;

            // EBIT Bonus Breakdown
            doc.setFontSize(11);
            doc.setTextColor(46, 117, 182);
            doc.setFont(undefined, 'bold');
            doc.text('S√§ule 1: EBIT Bonus (70% Gewichtung)', leftMargin + 3, y);
            y += 6;

            doc.setFontSize(9);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'bold');

            // EBIT Breakdown Table header
            doc.setFillColor(230, 240, 255);
            doc.rect(leftMargin, y, 60, 6, 'F');
            doc.rect(leftMargin + 60, y, 40, 6, 'F');
            doc.rect(leftMargin + 100, y, 25, 6, 'F');
            doc.rect(leftMargin + 125, y, 55, 6, 'F');
            doc.text('Stufe', leftMargin + 2, y + 4);
            doc.text('EBIT Betrag', leftMargin + 62, y + 4);
            doc.text('Rate', leftMargin + 102, y + 4);
            doc.text('Bonus', leftMargin + 127, y + 4);
            y += 6;

            doc.setFont(undefined, 'normal');
            ebitBonusResult.breakdown.forEach((item, index) => {
                if (index % 2 === 0) {
                    doc.setFillColor(250, 250, 250);
                    doc.rect(leftMargin, y, 180, 6, 'F');
                }
                doc.text(item.stufe, leftMargin + 2, y + 4);
                doc.text(formatNumber(item.betrag) + ' N$', leftMargin + 62, y + 4);
                doc.text(item.rate.toFixed(1) + '%', leftMargin + 102, y + 4);
                doc.text(formatNumber(item.bonus) + ' N$', rightMargin - 3, y + 4, { align: 'right' });
                y += 6;
            });

            doc.setFillColor(227, 242, 253);
            doc.rect(leftMargin, y, 180, 7, 'F');
            doc.setFont(undefined, 'bold');
            doc.text('EBIT Bonus Total (ungew.)', leftMargin + 2, y + 5);
            doc.text(formatNumber(ebitBonusRaw) + ' N$', rightMargin - 3, y + 5, { align: 'right' });
            y += 7;

            doc.setFillColor(100, 181, 246);
            doc.setTextColor(255, 255, 255);
            doc.rect(leftMargin, y, 180, 7, 'F');
            doc.text('EBIT Bonus (70% gew.)', leftMargin + 2, y + 5);
            doc.text(formatNumber(ebitBonusWeighted) + ' N$', rightMargin - 3, y + 5, { align: 'right' });
            y += 12;

            // Produktivit√§tsbonus
            doc.setTextColor(46, 117, 182);
            doc.setFontSize(11);
            doc.text('S√§ule 2: Produktivit√§tsbonus (30% Gewichtung)', leftMargin + 3, y);
            y += 6;

            doc.setFontSize(9);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');

            const prodData = [
                ['30% Basis (vom ungew. EBIT Bonus)', formatNumber(prodBonusBase) + ' N$'],
                ['√ó Produktivit√§ts-Faktor', prodFactor.toFixed(1) + '√ó']
            ];

            prodData.forEach((row) => {
                doc.text(row[0], leftMargin + 5, y);
                doc.text(row[1], rightMargin - 3, y, { align: 'right' });
                y += 5;
            });

            doc.setFillColor(100, 181, 246);
            doc.setTextColor(255, 255, 255);
            doc.rect(leftMargin, y, 180, 7, 'F');
            doc.setFont(undefined, 'bold');
            doc.text('Produktivit√§tsbonus (gew.)', leftMargin + 2, y + 5);
            doc.text(formatNumber(prodBonus) + ' N$', rightMargin - 3, y + 5, { align: 'right' });
            y += 12;

            // Subtotal
            const subtotal = ebitBonusWeighted + prodBonus;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.setFillColor(245, 245, 245);
            doc.rect(leftMargin, y, 180, 7, 'F');
            doc.setFont(undefined, 'bold');
            doc.text('Basis-Bonus (S√§ule 1 + S√§ule 2)', leftMargin + 2, y + 5);
            doc.text(formatNumber(subtotal) + ' N$', rightMargin - 3, y + 5, { align: 'right' });
            y += 12;

            // Skin in the Game
            doc.setFontSize(11);
            doc.setTextColor(46, 117, 182);
            doc.setFont(undefined, 'bold');
            doc.text('Skin in the Game Effekt', leftMargin + 3, y);
            y += 6;

            doc.setFontSize(9);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            doc.text('Investment:', leftMargin + 5, y);
            doc.text(formatNumber(investment) + ' N$', rightMargin - 3, y, { align: 'right' });
            y += 5;
            doc.text('Multiplikator:', leftMargin + 5, y);
            doc.text(multiplier.toFixed(2) + '√ó', rightMargin - 3, y, { align: 'right' });
            y += 5;
            doc.text('Basis-Bonus √ó Multiplikator:', leftMargin + 5, y);
            const bonusAfterMult = subtotal * multiplier;
            doc.text(formatNumber(bonusAfterMult) + ' N$', rightMargin - 3, y, { align: 'right' });
            y += 5;
            doc.text(`+ Zinsen (${(baseInterest * 100).toFixed(1)}%):`, leftMargin + 5, y);
            doc.text(formatNumber(interestAmount) + ' N$', rightMargin - 3, y, { align: 'right' });
            y += 8;

            // ========== GESAMTBONUS HIGHLIGHT ==========
            doc.setFillColor(102, 126, 234);
            doc.roundedRect(leftMargin, y, rightMargin - leftMargin, 25, 3, 3, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('GESAMTBONUS', leftMargin + 5, y + 8);
            doc.setFontSize(20);
            doc.text(`${formatNumber(totalBonus)} N$`, leftMargin + 5, y + 18);
            doc.setFontSize(11);
            doc.text(`${bonusPercentage}% vom Grundgehalt`, rightMargin - 5, y + 18, { align: 'right' });
            y += 30;

            // ========== SECTION 5: AUSZAHLUNGSSTRUKTUR ==========
            doc.setFillColor(240, 240, 240);
            doc.rect(leftMargin, y, rightMargin - leftMargin, 8, 'F');
            doc.setTextColor(31, 78, 120);
            doc.setFontSize(13);
            doc.setFont(undefined, 'bold');
            doc.text('5. AUSZAHLUNGSSTRUKTUR', leftMargin + 3, y + 6);
            y += 12;

            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');

            // Payment boxes
            const paymentBoxWidth = 85;
            const gap = 10;

            // Sofort-Auszahlung
            doc.setFillColor(212, 237, 218);
            doc.roundedRect(leftMargin, y, paymentBoxWidth, 20, 2, 2, 'F');
            doc.setFont(undefined, 'bold');
            doc.text('Sofort-Auszahlung', leftMargin + 3, y + 6);
            doc.setFontSize(14);
            doc.setTextColor(21, 87, 36);
            doc.text(formatNumber(immediateAmount) + ' N$', leftMargin + 3, y + 14);
            doc.setFontSize(9);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            doc.text(`(${(immediateRate * 100).toFixed(0)}%)`, leftMargin + 3, y + 19);

            // Bonus Bank
            doc.setFillColor(255, 243, 224);
            doc.roundedRect(leftMargin + paymentBoxWidth + gap, y, paymentBoxWidth, 20, 2, 2, 'F');
            doc.setFont(undefined, 'bold');
            doc.text('Bonus Bank (3 Jahre)', leftMargin + paymentBoxWidth + gap + 3, y + 6);
            doc.setFontSize(14);
            doc.setTextColor(255, 111, 0);
            doc.text(formatNumber(bankAmount) + ' N$', leftMargin + paymentBoxWidth + gap + 3, y + 14);
            doc.setFontSize(9);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            doc.text(`(${((1 - immediateRate) * 100).toFixed(0)}%)`, leftMargin + paymentBoxWidth + gap + 3, y + 19);

            y += 28;

            // ========== FOOTER ==========
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text('Dieser Bericht wurde automatisch generiert durch das Farm Bonussystem Tool', pageWidth / 2, 285, { align: 'center' });
            doc.text(`¬© ${new Date().getFullYear()} - Vertraulich - Nur f√ºr internen Gebrauch`, pageWidth / 2, 290, { align: 'center' });

            // Save PDF
            doc.save(`farm-bonus-bericht-${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Update overview if switched to it
            if (tabName === 'overview') {
                updateOverview();
            }
        }

        function updateOverview() {
            // Get current calculated values from the last calculation
            const herdSize = parseFloat(document.getElementById('herdSize').value);
            const slaughterWeight = parseFloat(document.getElementById('slaughterWeight').value);
            const salesRate = parseFloat(document.getElementById('salesRate').value) / 100;
            const pricePerKg = parseFloat(document.getElementById('pricePerKg').value);
            const soldAnimals = Math.round(herdSize * salesRate);
            const totalSlaughterWeight = soldAnimals * slaughterWeight;
            const cattleRevenue = totalSlaughterWeight * pricePerKg;
            const huntingRevenue = parseInput(document.getElementById('huntingRevenue'));
            const rentRevenue = parseInput(document.getElementById('rentRevenue'));
            const otherRevenue = parseInput(document.getElementById('otherRevenue'));
            const baseCosts = parseInput(document.getElementById('baseCosts'));
            const totalRevenue = cattleRevenue + huntingRevenue + rentRevenue + otherRevenue;
            const ebit = totalRevenue - baseCosts;
            const productivityIndex = (baseCosts > 0) ? (totalSlaughterWeight / baseCosts) * 1000 : 0;
            const totalBonusText = document.getElementById('totalBonus').textContent;

            // Update current situation
            document.getElementById('overviewCurrentEbit').textContent = formatNumber(ebit) + ' N$';
            document.getElementById('overviewProdIndex').textContent = productivityIndex.toFixed(1);
            document.getElementById('overviewCurrentBonus').textContent = totalBonusText;

            // Calculate EBIT targets
            const target100k = calculateEbitBonus(100000);
            const target500k = calculateEbitBonus(500000);
            const target2M = calculateEbitBonus(2000000);
            const target4M = calculateEbitBonus(4000000);

            // Update EBIT targets table
            document.getElementById('targetEntry').textContent = formatNumber(100000) + ' N$';
            document.getElementById('targetEntryBonus').textContent = formatNumber(target100k.total * 0.7) + ' N$';
            document.getElementById('targetEntryTotal').textContent = '~' + formatNumber(target100k.total * 0.7 * 1.43) + ' N$';
            document.getElementById('targetEntryStatus').textContent = ebit >= 100000 ? '‚úÖ' : '‚ùå';

            document.getElementById('targetTier2').textContent = formatNumber(500000) + ' N$';
            document.getElementById('targetTier2Bonus').textContent = formatNumber(target500k.total * 0.7) + ' N$';
            document.getElementById('targetTier2Total').textContent = '~' + formatNumber(target500k.total * 0.7 * 1.43) + ' N$';
            document.getElementById('targetTier2Status').textContent = ebit >= 500000 ? '‚úÖ' : '‚ùå';

            document.getElementById('targetTier3').textContent = formatNumber(2000000) + ' N$';
            document.getElementById('targetTier3Bonus').textContent = formatNumber(target2M.total * 0.7) + ' N$';
            document.getElementById('targetTier3Total').textContent = '~' + formatNumber(target2M.total * 0.7 * 1.43) + ' N$';
            document.getElementById('targetTier3Status').textContent = ebit >= 2000000 ? '‚úÖ' : '‚ùå';

            document.getElementById('targetMax').textContent = formatNumber(4000000) + ' N$';
            document.getElementById('targetMaxBonus').textContent = formatNumber(target4M.total * 0.7) + ' N$';
            document.getElementById('targetMaxTotal').textContent = '~' + formatNumber(target4M.total * 0.7 * 1.43) + ' N$';
            document.getElementById('targetMaxStatus').textContent = ebit >= 4000000 ? '‚úÖ' : '‚ùå';

            // Calculate productivity targets
            const kgFor15 = (15 * baseCosts) / 1000;
            const kgFor20 = (20 * baseCosts) / 1000;
            const kgFor25 = (25 * baseCosts) / 1000;

            document.getElementById('prodCritical').textContent = '< ' + formatNumber(kgFor15) + ' kg';
            document.getElementById('prodCriticalStatus').textContent = productivityIndex < 15 ? '‚¨ÖÔ∏è Aktuell' : '';

            document.getElementById('prodBasis').textContent = formatNumber(kgFor15) + ' - ' + formatNumber(kgFor20) + ' kg';
            document.getElementById('prodBasisStatus').textContent = (productivityIndex >= 15 && productivityIndex <= 20) ? '‚¨ÖÔ∏è Aktuell' : '';

            document.getElementById('prodGood').textContent = formatNumber(kgFor20) + ' - ' + formatNumber(kgFor25) + ' kg';
            document.getElementById('prodGoodStatus').textContent = (productivityIndex > 20 && productivityIndex <= 25) ? '‚¨ÖÔ∏è Aktuell' : '';

            document.getElementById('prodExcellent').textContent = '> ' + formatNumber(kgFor25) + ' kg';
            document.getElementById('prodExcellentStatus').textContent = productivityIndex > 25 ? '‚¨ÖÔ∏è Aktuell' : '';

            // Generate recommendations
            let recommendations = '';

            if (ebit < 100000) {
                recommendations += '<div class="warning" style="margin-bottom: 15px;"><strong>üéØ Priorit√§t 1:</strong> EBIT steigern auf mindestens 100.000 N$ um ins Bonussystem einzusteigen.</div>';
            } else if (ebit < 500000) {
                recommendations += '<div class="info-box" style="margin-bottom: 15px;"><strong>üéØ N√§chstes Ziel:</strong> EBIT auf 500.000 N$ erh√∂hen f√ºr Tier 2 (12% Rate). Noch ' + formatNumber(500000 - ebit) + ' N$ ben√∂tigt.</div>';
            } else if (ebit < 2000000) {
                recommendations += '<div class="info-box" style="margin-bottom: 15px;"><strong>üéØ N√§chstes Ziel:</strong> EBIT auf 2.000.000 N$ erh√∂hen f√ºr Tier 3 (15% Rate). Noch ' + formatNumber(2000000 - ebit) + ' N$ ben√∂tigt.</div>';
            } else if (ebit < 4000000) {
                recommendations += '<div class="info-box" style="margin-bottom: 15px;"><strong>üéØ N√§chstes Ziel:</strong> EBIT auf 4.000.000 N$ erh√∂hen f√ºr maximalen Bonus. Noch ' + formatNumber(4000000 - ebit) + ' N$ ben√∂tigt.</div>';
            } else {
                recommendations += '<div class="success" style="margin-bottom: 15px;"><strong>‚úÖ Exzellent!</strong> EBIT-Cap erreicht - maximaler EBIT-Bonus wird ausgezahlt.</div>';
            }

            if (productivityIndex < 15) {
                recommendations += '<div class="warning" style="margin-bottom: 15px;"><strong>‚ö†Ô∏è Kritisch:</strong> Produktivit√§tsindex zu niedrig (kein Produktivit√§tsbonus). Mindestens ' + formatNumber(kgFor15 - totalSlaughterWeight) + ' kg mehr verkaufen oder Kosten senken.</div>';
            } else if (productivityIndex <= 20) {
                recommendations += '<div class="info-box" style="margin-bottom: 15px;"><strong>üí° Verbesserung m√∂glich:</strong> Produktivit√§tsindex auf >20 erh√∂hen f√ºr 1,5√ó Faktor. Noch ' + formatNumber(kgFor20 - totalSlaughterWeight) + ' kg verkauftes Gewicht ben√∂tigt.</div>';
            } else if (productivityIndex <= 25) {
                recommendations += '<div class="info-box" style="margin-bottom: 15px;"><strong>üí° Fast Top:</strong> Produktivit√§tsindex auf >25 erh√∂hen f√ºr 2√ó Faktor (Exzellent). Noch ' + formatNumber(kgFor25 - totalSlaughterWeight) + ' kg verkauftes Gewicht ben√∂tigt.</div>';
            } else {
                recommendations += '<div class="success" style="margin-bottom: 15px;"><strong>‚≠ê Exzellent!</strong> Produktivit√§tsindex im Top-Bereich - maximaler Produktivit√§tsbonus (2√ó Faktor).</div>';
            }

            const investment = parseFloat(document.getElementById('investment').value) || 0;
            if (investment < 140000) {
                const remaining = 140000 - investment;
                recommendations += '<div class="info-box"><strong>üí∞ Skin in the Game:</strong> Aktuelles Investment: ' + formatNumber(investment) + ' N$. F√ºr maximalen Multiplikator noch ' + formatNumber(remaining) + ' N$ investieren.</div>';
            } else {
                recommendations += '<div class="success"><strong>‚úÖ Maximum erreicht:</strong> Skin in the Game Investment vollst√§ndig - maximaler Multiplikator aktiv!</div>';
            }

            document.getElementById('recommendations').innerHTML = recommendations;
        }
        
        function formatNumber(num) {
            return Math.round(num).toLocaleString('de-DE');
        }
        
        function formatInput(input) {
            // Get raw number value (remove all dots)
            let value = input.value.replace(/\./g, '');
            
            // Remove non-digits
            value = value.replace(/\D/g, '');
            
            // Convert to number and format with thousand separators
            if (value === '') {
                input.value = '0';
            } else {
                const num = parseInt(value);
                input.value = num.toLocaleString('de-DE');
            }
        }
        
        function parseInput(input) {
            // Parse formatted input back to number
            return parseFloat(input.value.replace(/\./g, '')) || 0;
        }
        
        function updateValue(id) {
            const input = document.getElementById(id);
            const value = parseFloat(input.value);
            const display = document.getElementById(id + 'Value');
            
            if (id.includes('Rate') || id === 'baseInterest' || id === 'immediatePayment') {
                display.textContent = value + '%';
            } else if (id === 'multiplierMax') {
                display.textContent = value.toFixed(1) + 'x';
            } else if (id === 'ebitCap') {
                display.textContent = value.toFixed(1) + 'M';
            } else if (id === 'investment') {
                display.textContent = formatNumber(value);
            } else {
                display.textContent = formatNumber(value);
            }
        }
        
        function calculateEbitBonus(ebit) {
            const tier1Rate = parseFloat(document.getElementById('tier1Rate').value) / 100;
            const tier2Rate = parseFloat(document.getElementById('tier2Rate').value) / 100;
            const tier3Rate = parseFloat(document.getElementById('tier3Rate').value) / 100;
            const tier4Rate = parseFloat(document.getElementById('tier4Rate').value) / 100;
            const ebitCap = parseFloat(document.getElementById('ebitCap').value) * 1000000;
            
            const cappedEbit = Math.min(ebit, ebitCap);
            let totalBonus = 0;
            const breakdown = [];
            
            // Stufe 1: 0-100k
            if (cappedEbit > 0) {
                const amount = Math.min(cappedEbit, 100000);
                const bonus = amount * tier1Rate;
                totalBonus += bonus;
                breakdown.push({
                    stufe: 'Stufe 1 (0-100k)',
                    betrag: amount,
                    rate: tier1Rate * 100,
                    bonus: bonus
                });
            }
            
            // Stufe 2: 100k-500k
            if (cappedEbit > 100000) {
                const amount = Math.min(cappedEbit - 100000, 400000);
                const bonus = amount * tier2Rate;
                totalBonus += bonus;
                breakdown.push({
                    stufe: 'Stufe 2 (100k-500k)',
                    betrag: amount,
                    rate: tier2Rate * 100,
                    bonus: bonus
                });
            }
            
            // Stufe 3: 500k-2M
            if (cappedEbit > 500000) {
                const amount = Math.min(cappedEbit - 500000, 1500000);
                const bonus = amount * tier3Rate;
                totalBonus += bonus;
                breakdown.push({
                    stufe: 'Stufe 3 (500k-2M)',
                    betrag: amount,
                    rate: tier3Rate * 100,
                    bonus: bonus
                });
            }
            
            // Stufe 4: 2M-4M
            if (cappedEbit > 2000000) {
                const amount = cappedEbit - 2000000;
                const bonus = amount * tier4Rate;
                totalBonus += bonus;
                breakdown.push({
                    stufe: 'Stufe 4 (2M+)',
                    betrag: amount,
                    rate: tier4Rate * 100,
                    bonus: bonus
                });
            }
            
            return {
                total: totalBonus,
                breakdown: breakdown
            };
        }
        
        function calculate() {
            // Auto-save to localStorage
            saveToLocalStorage();

            // Herdenberechnung
            const herdSize = parseFloat(document.getElementById('herdSize').value);
            const slaughterWeight = parseFloat(document.getElementById('slaughterWeight').value);
            const salesRate = parseFloat(document.getElementById('salesRate').value) / 100;
            const pricePerKg = parseFloat(document.getElementById('pricePerKg').value);
            
            const soldAnimals = Math.round(herdSize * salesRate);
            const totalSlaughterWeight = soldAnimals * slaughterWeight;
            const cattleRevenue = totalSlaughterWeight * pricePerKg;
            
            // Sonstige Einnahmen
            const huntingRevenue = parseInput(document.getElementById('huntingRevenue')) || 0;
            const rentRevenue = parseInput(document.getElementById('rentRevenue')) || 0;
            const otherRevenue = parseInput(document.getElementById('otherRevenue')) || 0;
            const totalRevenue = cattleRevenue + huntingRevenue + rentRevenue + otherRevenue;
            
            // Kosten berechnen (FIXE KOSTEN)
            const baseCosts = parseInput(document.getElementById('baseCosts'));
            const totalCost = baseCosts;
            
            // EBIT
            const ebit = totalRevenue - totalCost;
            
            // Calculate EBIT Bonus (PROGRESSIVE - KORRIGIERT!)
            const ebitBonusResult = calculateEbitBonus(ebit);
            const ebitBonusRaw = ebitBonusResult.total;
            const ebitBonusTotal = ebitBonusRaw * 0.7; // 70% weighting
            
            // Calculate Productivity Index and Bonus (KORREKT nach PDF!)
            // Formel: (kg Schlachtgewicht verkauft √∑ Gesamtkosten) √ó 1000
            // Protection against division by zero
            const productivityIndex = (totalCost > 0) ? (totalSlaughterWeight / totalCost) * 1000 : 0;

            // Bonus-Faktor basierend auf Index (laut PDF Seite 4)
            let prodBonusFactor = 0;
            let prodRating = "";
            if (totalCost <= 0) {
                prodBonusFactor = 0;
                prodRating = "‚ö†Ô∏è Keine Kosten - nicht berechenbar";
            } else if (productivityIndex < 15) {
                prodBonusFactor = 0;
                prodRating = "üî¥ Kritisch (Verlustzone)";
            } else if (productivityIndex <= 20) {
                prodBonusFactor = 1;
                prodRating = "üü° Basis (Verbesserung n√∂tig)";
            } else if (productivityIndex <= 25) {
                prodBonusFactor = 1.5;
                prodRating = "üü¢ Gut (Namibia-Standard)";
            } else {
                prodBonusFactor = 2;
                prodRating = "‚≠ê Exzellent (Top 20%)";
            }
            
            // KORRIGIERTE BERECHNUNG:
            // Bei Faktor 1,0 ‚Üí 30% vom ungewichteten EBIT-Bonus
            // Bei anderen Faktoren ‚Üí entsprechend skaliert
            const prodBonusBase = ebitBonusRaw * 0.3; // 30% vom ungewichteten EBIT-Bonus
            const prodBonusTotal = prodBonusBase * prodBonusFactor; // mal Faktor
            
            // Subtotal
            const subtotal = ebitBonusTotal + prodBonusTotal;
            
            // Skin in the Game
            const investment = parseFloat(document.getElementById('investment').value) || 0;
            const multiplierMax = parseFloat(document.getElementById('multiplierMax').value);
            const investmentRatio = Math.min(investment / 140000, 1.0); // Cap at 1.0
            const multiplier = 1 + (multiplierMax - 1) * investmentRatio;
            const bonusWithMultiplier = subtotal * multiplier;
            
            // Interest
            const baseInterest = parseFloat(document.getElementById('baseInterest').value) / 100;
            const interestAmount = investment * baseInterest;
            
            // Total
            const totalBonus = bonusWithMultiplier + interestAmount;
            const baseSalary = parseInput(document.getElementById('baseSalary'));
            const bonusPercentage = (totalBonus / baseSalary * 100) || 0;
            
            // Payment structure
            const immediateRate = parseFloat(document.getElementById('immediatePayment').value) / 100;
            const immediateAmount = totalBonus * immediateRate;
            const bankAmount = totalBonus * (1 - immediateRate);
            
            // Update Herdenkennzahlen
            document.getElementById('displayHerdSize').textContent = formatNumber(herdSize) + ' Tiere';
            document.getElementById('soldAnimals').textContent = formatNumber(soldAnimals);
            document.getElementById('totalWeight').textContent = formatNumber(totalSlaughterWeight) + ' kg';
            document.getElementById('avgWeight').textContent = formatNumber(slaughterWeight) + ' kg';
            
            // Update formula display
            document.getElementById('soldAnimalsDetail').textContent = 
                `${formatNumber(soldAnimals)} √ó ${formatNumber(slaughterWeight)} kg √ó ${formatNumber(pricePerKg)} N$/kg`;
            
            // Update EBIT Berechnung
            document.getElementById('cattleRevenue').textContent = formatNumber(cattleRevenue) + ' N$';
            document.getElementById('displayHunting').textContent = formatNumber(huntingRevenue) + ' N$';
            document.getElementById('displayRent').textContent = formatNumber(rentRevenue) + ' N$';
            document.getElementById('displayOther').textContent = formatNumber(otherRevenue) + ' N$';
            document.getElementById('totalRevenue').textContent = formatNumber(totalRevenue) + ' N$';
            document.getElementById('totalCost').textContent = formatNumber(totalCost) + ' N$';
            document.getElementById('ebitAmount').textContent = formatNumber(ebit) + ' N$';
            
            // Update EBIT im Bonus-Tab
            document.getElementById('ebitDisplayBonus').textContent = formatNumber(ebit) + ' N$';
            
            // Update Produktivit√§tsindex Anzeige
            document.getElementById('totalKgSold').textContent = formatNumber(totalSlaughterWeight) + ' kg';
            document.getElementById('totalCostsProd').textContent = formatNumber(totalCost) + ' N$';
            document.getElementById('prodIndexValue').textContent = productivityIndex.toFixed(1);
            document.getElementById('prodRating').textContent = prodRating;
            
            // EBIT Breakdown Table
            let breakdownHTML = '';
            ebitBonusResult.breakdown.forEach(item => {
                breakdownHTML += `
                    <tr>
                        <td>${item.stufe}</td>
                        <td>${formatNumber(item.betrag)} N$</td>
                        <td>${item.rate.toFixed(1)}%</td>
                        <td>${formatNumber(item.bonus)} N$</td>
                    </tr>
                `;
            });
            document.getElementById('ebitBreakdown').innerHTML = breakdownHTML;
            
            document.getElementById('ebitBonusRaw').textContent = formatNumber(ebitBonusRaw) + ' N$';
            document.getElementById('ebitBonus').textContent = formatNumber(ebitBonusTotal) + ' N$';
            
            // Update Produktivit√§tsbonus Anzeige (neue Struktur)
            document.getElementById('prodIndexDisplay').textContent = productivityIndex.toFixed(1);
            document.getElementById('prodRatingDisplay').textContent = prodRating;
            document.getElementById('prodFactorDisplay').textContent = prodBonusFactor.toFixed(1) + 'x';
            document.getElementById('ebitBonusRawProd').textContent = formatNumber(ebitBonusRaw) + ' N$';
            document.getElementById('prodBonusBase').textContent = formatNumber(prodBonusBase) + ' N$';
            document.getElementById('prodFactorCalc').textContent = '√ó ' + prodBonusFactor.toFixed(1);
            document.getElementById('prodBonus').textContent = formatNumber(prodBonusTotal) + ' N$';
            
            document.getElementById('subtotal').textContent = formatNumber(subtotal) + ' N$';
            document.getElementById('multiplierCalc').textContent = multiplier.toFixed(2) + 'x';
            document.getElementById('multiplierBonus').textContent = formatNumber(bonusWithMultiplier) + ' N$';
            document.getElementById('interestAmount').textContent = formatNumber(interestAmount) + ' N$';
            document.getElementById('totalBonus').textContent = formatNumber(totalBonus) + ' N$';
            document.getElementById('bonusPercentage').textContent = bonusPercentage.toFixed(1) + '% vom Grundgehalt';
            document.getElementById('immediateAmount').textContent = formatNumber(immediateAmount) + ' N$';
            document.getElementById('bankAmount').textContent = formatNumber(bankAmount) + ' N$';
            
            // Status message
            const statusDiv = document.getElementById('statusMessage');
            if (ebit < 0) {
                statusDiv.className = 'warning';
                statusDiv.innerHTML = '<strong>‚ö†Ô∏è Warnung:</strong> Die Farm macht Verlust!';
            } else if (ebit < 500000) {
                statusDiv.className = 'warning';
                statusDiv.innerHTML = '<strong>‚ö†Ô∏è Hinweis:</strong> EBIT zu niedrig f√ºr attraktiven Bonus.';
            } else {
                statusDiv.className = 'success';
                statusDiv.innerHTML = '<strong>‚úÖ Gut:</strong> Solide Performance mit fairem Bonus.';
            }
        }
        
        function updateDashboard() {
            const baseSalary = parseInput(document.getElementById('baseSalary'));
            const investment = parseFloat(document.getElementById('investment').value);
            
            // Calculate key statistics
            const bonus1M = calculateEbitBonus(1000000).total * 0.7;
            const bonus2M = calculateEbitBonus(2000000).total * 0.7;
            const maxBonus = calculateEbitBonus(parseFloat(document.getElementById('ebitCap').value) * 1000000).total * 0.7;
            
            document.getElementById('bonus1M').textContent = formatNumber(bonus1M);
            document.getElementById('bonus2M').textContent = formatNumber(bonus2M);
            document.getElementById('maxBonus').textContent = formatNumber(maxBonus);
            
            // Find break-even (extend search to ebitCap)
            const ebitCapValue = parseFloat(document.getElementById('ebitCap').value) * 1000000;
            let breakEven = 0;
            for (let ebit = 0; ebit <= ebitCapValue; ebit += 10000) {
                if (calculateEbitBonus(ebit).total * 0.7 >= baseSalary * 0.01) {
                    breakEven = ebit;
                    break;
                }
            }
            if (breakEven === 0 && calculateEbitBonus(ebitCapValue).total * 0.7 < baseSalary * 0.01) {
                document.getElementById('breakEven').textContent = '> ' + formatNumber(ebitCapValue);
            } else {
                document.getElementById('breakEven').textContent = formatNumber(breakEven);
            }
            
            // Update charts
            updateBonusChart();
            updateComparisonChart();
            updateDetailTable();
        }
        
        function updateBonusChart() {
            const ctx = document.getElementById('bonusChart').getContext('2d');
            const ebitPoints = [];
            const bonusPoints = [];
            
            for (let ebit = 0; ebit <= 5000000; ebit += 250000) {
                ebitPoints.push(ebit);
                bonusPoints.push(calculateEbitBonus(ebit).total * 0.7);
            }
            
            if (bonusChart) {
                bonusChart.destroy();
            }
            
            bonusChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ebitPoints.map(val => formatNumber(val)),
                    datasets: [{
                        label: 'Bonus (N$)',
                        data: bonusPoints,
                        borderColor: 'rgb(68, 114, 196)',
                        backgroundColor: 'rgba(68, 114, 196, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Bonus-Kurve nach EBIT (Progressive Berechnung)',
                            font: { size: 16, weight: 'bold' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Bonus (N$)' },
                            ticks: { callback: value => formatNumber(value) }
                        },
                        x: {
                            title: { display: true, text: 'EBIT (N$)' }
                        }
                    }
                }
            });
        }
        
        function updateComparisonChart() {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            const ebitPoints = [];
            
            for (let ebit = 0; ebit <= 5000000; ebit += 250000) {
                ebitPoints.push(ebit);
            }
            
            const currentBonus = ebitPoints.map(ebit => calculateEbitBonus(ebit).total * 0.7);
            
            // Conservative scenario
            const conservativeBonus = ebitPoints.map(ebit => {
                const tempTiers = [0.05, 0.08, 0.10, 0.12];
                let bonus = 0;
                const cappedEbit = Math.min(ebit, 4000000);
                if (cappedEbit > 0) bonus += Math.min(cappedEbit, 100000) * tempTiers[0];
                if (cappedEbit > 100000) bonus += Math.min(cappedEbit - 100000, 400000) * tempTiers[1];
                if (cappedEbit > 500000) bonus += Math.min(cappedEbit - 500000, 1500000) * tempTiers[2];
                if (cappedEbit > 2000000) bonus += Math.min(cappedEbit - 2000000, 2000000) * tempTiers[3];
                return bonus * 0.7;
            });
            
            // Aggressive scenario
            const aggressiveBonus = ebitPoints.map(ebit => {
                const tempTiers = [0.12, 0.18, 0.22, 0.28];
                let bonus = 0;
                const cappedEbit = Math.min(ebit, 4000000);
                if (cappedEbit > 0) bonus += Math.min(cappedEbit, 100000) * tempTiers[0];
                if (cappedEbit > 100000) bonus += Math.min(cappedEbit - 100000, 400000) * tempTiers[1];
                if (cappedEbit > 500000) bonus += Math.min(cappedEbit - 500000, 1500000) * tempTiers[2];
                if (cappedEbit > 2000000) bonus += Math.min(cappedEbit - 2000000, 2000000) * tempTiers[3];
                return bonus * 0.7;
            });
            
            if (comparisonChart) {
                comparisonChart.destroy();
            }
            
            comparisonChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ebitPoints.map(val => formatNumber(val)),
                    datasets: [{
                        label: 'Aktuelle Einstellung',
                        data: currentBonus,
                        borderColor: 'rgb(68, 114, 196)',
                        borderWidth: 3,
                        fill: false
                    }, {
                        label: 'Konservativ',
                        data: conservativeBonus,
                        borderColor: 'rgb(75, 192, 192)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false
                    }, {
                        label: 'Aggressiv',
                        data: aggressiveBonus,
                        borderColor: 'rgb(255, 99, 132)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Vergleich: Konservativ vs. Aktuell vs. Aggressiv',
                            font: { size: 16, weight: 'bold' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: value => formatNumber(value) }
                        }
                    }
                }
            });
        }
        
        function updateDetailTable() {
            const baseSalary = parseInput(document.getElementById('baseSalary'));
            const tbody = document.getElementById('detailTable');
            const keyPoints = [100000, 250000, 500000, 750000, 1000000, 1500000, 2000000, 2500000, 3000000, 3500000, 4000000];
            
            let html = '';
            keyPoints.forEach(ebit => {
                const bonus = calculateEbitBonus(ebit).total * 0.7;
                const percentage = (bonus / baseSalary * 100).toFixed(1);
                const effectiveRate = (bonus / ebit * 100).toFixed(2);
                
                html += `
                    <tr>
                        <td>${formatNumber(ebit)}</td>
                        <td>${formatNumber(bonus)}</td>
                        <td>${percentage}%</td>
                        <td>${effectiveRate}%</td>
                        <td>-</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Initialize
        window.onload = function() {
            // Try to load from localStorage first
            const loaded = loadFromLocalStorage();

            // Update all range value displays
            ['tier1Rate', 'tier2Rate', 'tier3Rate', 'tier4Rate', 'ebitCap',
             'investment', 'multiplierMax', 'baseInterest', 'immediatePayment',
             'herdSize', 'slaughterWeight', 'salesRate'].forEach(id => {
                updateValue(id);
            });

            // Calculate with loaded or default values
            calculate();

            if (loaded) {
                console.log('‚úÖ Daten aus LocalStorage geladen');
            }
        };
    </script>
</body>
</html>