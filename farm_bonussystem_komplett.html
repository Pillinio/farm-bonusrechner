<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bonussystem - Erichsfelde</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1F4E78 0%, #2E75B6 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
        }

        .header-logo {
            width: 120px;
            height: auto;
            max-height: 100px;
            object-fit: contain;
        }

        .header-content {
            flex: 1;
            max-width: 800px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }
            .header-logo {
                width: 80px;
                height: 80px;
            }
            .header h1 {
                font-size: 1.8em;
            }
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        
        .tab {
            flex: 1;
            padding: 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            color: #495057;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab:hover {
            background: rgba(68, 114, 196, 0.1);
        }
        
        .tab.active {
            color: #2E75B6;
            background: white;
            border-bottom: 3px solid #2E75B6;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }
        
        .input-section, .output-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #dee2e6;
        }
        
        h2 {
            color: #2E75B6;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #2E75B6;
            font-size: 1.5em;
        }
        
        h3 {
            color: #4472C4;
            margin-top: 20px;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .input-group {
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 600;
            font-size: 0.95em;
        }
        
        input[type="number"], input[type="range"], select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ced4da;
            border-radius: 6px;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #4472C4;
            box-shadow: 0 0 0 3px rgba(68, 114, 196, 0.1);
        }
        
        input[type="range"] {
            -webkit-appearance: none;
            height: 8px;
            background: #ddd;
            outline: none;
            border: none;
            padding: 0;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #4472C4;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #4472C4;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .range-value {
            display: inline-block;
            margin-left: 10px;
            padding: 5px 10px;
            background: #4472C4;
            color: white;
            border-radius: 4px;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
        }
        
        .result-box {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            border-left: 5px solid #4472C4;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .result-box h4 {
            color: #2E75B6;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }
        
        .result-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .result-label {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .result-value {
            color: #2E75B6;
            font-size: 1.3em;
            font-weight: bold;
        }
        
        .highlight-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .highlight-box h4 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        
        .total-bonus {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .percentage {
            font-size: 1.5em;
            opacity: 0.9;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        th {
            background: #4472C4;
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #28a745;
        }
        
        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #ffc107;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            margin-bottom: 30px;
            height: 500px;
        }
        
        .control-panel {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #dee2e6;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .info-box strong {
            color: #1976D2;
        }

        .export-controls {
            display: flex;
            gap: 10px;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        input[type="file"] {
            display: none;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            margin-left: 5px;
            width: 18px;
            height: 18px;
            line-height: 18px;
            text-align: center;
            background: #4472C4;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background-color: #2E75B6;
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 13px;
            line-height: 1.5;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -8px;
            border-width: 8px;
            border-style: solid;
            border-color: #2E75B6 transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .admin-toggle {
            position: absolute;
            top: 10px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.5);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .admin-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.8);
        }

        .admin-toggle.active {
            background: #28a745;
            border-color: #28a745;
        }

        .locked {
            opacity: 0.6;
            pointer-events: none;
            position: relative;
        }

        .locked::after {
            content: 'üîí';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
        }

        .header {
            position: relative;
        }

        .admin-only-hide {
            display: none;
        }

        .admin-display {
            display: block;
        }

        .admin-edit {
            display: none;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .tooltip .tooltiptext {
                width: 220px;
                margin-left: -110px;
            }

            .admin-toggle {
                position: static;
                margin: 10px auto;
                display: block;
                width: fit-content;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="logo.png" alt="Farm Erichsfelde Logo" class="header-logo">
            <div class="header-content">
                <h1>Bonussystem - Erichsfelde</h1>
            </div>
            <img src="namibia-flag.png" alt="Namibia Flag" class="header-logo">
            <button class="admin-toggle" id="adminToggle" onclick="toggleAdminMode()">üîí Admin-Modus</button>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('ebit')">üìä EBIT Berechnung</button>
            <button class="tab" onclick="switchTab('bonus')">üí∞ Bonusberechnung</button>
            <button class="tab" onclick="switchTab('overview')">üìä Bonus Detailansicht</button>
            <button class="tab" onclick="switchTab('info')">‚ÑπÔ∏è Info & Hilfe</button>
        </div>

        <div class="export-controls">
            <button class="btn btn-primary" onclick="exportToJSON()" title="Speichert alle aktuellen Parameter als JSON-Datei. Perfekt um verschiedene Szenarien zu vergleichen.">üíæ JSON Export</button>
            <button class="btn btn-secondary" onclick="document.getElementById('jsonFileInput').click()" title="L√§dt zuvor gespeicherte Parameter aus einer JSON-Datei.">üìÅ JSON Import</button>
            <input type="file" id="jsonFileInput" accept=".json" onchange="importFromJSON(event)">
            <button class="btn btn-success" onclick="exportToPDF()" title="Erstellt einen professionellen PDF-Bericht mit allen Berechnungen zum Ausdrucken oder Teilen.">üìÑ PDF Export</button>
            <div style="flex: 1;"></div>
            <span style="display: flex; align-items: center; color: #6c757d; font-size: 0.9em;" title="Ihre Eingaben werden automatisch im Browser gespeichert und beim n√§chsten √ñffnen wiederhergestellt.">
                üíæ Auto-Save aktiv
            </span>
        </div>
        
        <!-- TAB 1: EBIT BERECHNUNG -->
        <div id="ebit" class="tab-content active">
            <div class="main-content">
                <div class="input-section">
                    <h2>üêÑ Herdenparameter</h2>
                    <div class="input-group">
                        <label>Herdengr√∂√üe: <span class="range-value" id="herdSizeValue">800</span>
                            <span class="tooltip">?
                                <span class="tooltiptext">Gesamtzahl der Tiere auf der Farm. Standardwert f√ºr namibische Rinderfarmen: 800-1.200 Tiere.</span>
                            </span>
                        </label>
                        <input type="range" id="herdSize" min="400" max="1500" value="800" oninput="updateValue('herdSize'); calculate()">
                    </div>

                    <div class="input-group">
                        <label>Schlachtgewicht pro Tier (kg): <span class="range-value" id="slaughterWeightValue">225</span>
                            <span class="tooltip">?
                                <span class="tooltiptext">Durchschnittliches Gewicht eines verkauften Tieres nach der Schlachtung. Typ. 180-280 kg in Namibia.</span>
                            </span>
                        </label>
                        <input type="range" id="slaughterWeight" min="180" max="280" value="225" oninput="updateValue('slaughterWeight'); calculate()">
                    </div>

                    <div class="input-group">
                        <label>Verkaufsrate (%): <span class="range-value" id="salesRateValue">26%</span>
                            <span class="tooltip">?
                                <span class="tooltiptext">Prozentsatz der Herde, der j√§hrlich verkauft wird. Typ. 20-30% f√ºr nachhaltige Bewirtschaftung.</span>
                            </span>
                        </label>
                        <input type="range" id="salesRate" min="15" max="40" value="26" step="0.5" oninput="updateValue('salesRate'); calculate()">
                    </div>

                    <div class="input-group">
                        <label for="pricePerKg">Preis pro kg Schlachtgewicht (N$)
                            <span class="tooltip">?
                                <span class="tooltiptext">Verkaufspreis pro Kilogramm Schlachtgewicht in Namibia-Dollar. Marktpreis variiert je nach Qualit√§t und Nachfrage.</span>
                            </span>
                        </label>
                        <input type="number" id="pricePerKg" value="60" step="1" oninput="calculate()">
                    </div>
                    
                    <h3>üí∞ Sonstige Einnahmen</h3>
                    <div class="input-group">
                        <label for="huntingRevenue">Jagd Einnahmen (N$)
                            <span class="tooltip">?
                                <span class="tooltiptext">Einnahmen aus Jagdlizenzen oder Troph√§enjagd auf dem Farmgel√§nde.</span>
                            </span>
                        </label>
                        <input type="text" id="huntingRevenue" value="0" oninput="formatInput(this); calculate()">
                    </div>

                    <div class="input-group">
                        <label for="rentRevenue">Pacht Einnahmen (N$)
                            <span class="tooltip">?
                                <span class="tooltiptext">Einnahmen aus Verpachtung von Land oder Weidefl√§chen an andere Farmer.</span>
                            </span>
                        </label>
                        <input type="text" id="rentRevenue" value="0" oninput="formatInput(this); calculate()">
                    </div>

                    <div class="input-group">
                        <label for="otherRevenue">Sonstige Einnahmen (N$)
                            <span class="tooltip">?
                                <span class="tooltiptext">Andere Einnahmen wie Verkauf von Fellen, Nebenprodukte, etc.</span>
                            </span>
                        </label>
                        <input type="text" id="otherRevenue" value="0" oninput="formatInput(this); calculate()">
                    </div>

                    <h3>üí∏ Kosten</h3>
                    <div class="input-group">
                        <label for="baseCosts">Betriebskosten (N$)
                            <span class="tooltip">?
                                <span class="tooltiptext">Gesamte j√§hrliche Betriebskosten: Personal, Futter, Veterin√§r, Instandhaltung, Wasser, Strom, etc.</span>
                            </span>
                        </label>
                        <input type="text" id="baseCosts" value="2.000.000" oninput="formatInput(this); calculate()">
                    </div>
                </div>
                
                <div class="output-section">
                    <h2>üìä EBIT Ergebnisse</h2>
                    
                    <div class="result-box">
                        <h4>üêÑ Herdenkennzahlen</h4>
                        <div class="result-grid">
                            <div class="result-item">
                                <div class="result-label">Herdengr√∂√üe</div>
                                <div class="result-value" id="displayHerdSize">800 Tiere</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">Verkaufte Tiere</div>
                                <div class="result-value" id="soldAnimals">208</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">Schlachtgewicht Total</div>
                                <div class="result-value" id="totalWeight">46.800 kg</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">√ò Schlachtgewicht/Tier</div>
                                <div class="result-value" id="avgWeight">225 kg</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="result-box">
                        <h4>üíµ Einnahmen & Kosten</h4>
                        <table>
                            <tr>
                                <td><strong>Viehverkauf</strong></td>
                                <td style="text-align: right;"><strong id="cattleRevenue">0 N$</strong></td>
                            </tr>
                            <tr>
                                <td>‚îî Verkaufte Tiere</td>
                                <td style="text-align: right; font-size: 0.9em; color: #6c757d;" id="soldAnimalsDetail">0 √ó 225 kg √ó 60 N$/kg</td>
                            </tr>
                            <tr>
                                <td>Jagd Einnahmen</td>
                                <td style="text-align: right;" id="displayHunting">0 N$</td>
                            </tr>
                            <tr>
                                <td>Pacht Einnahmen</td>
                                <td style="text-align: right;" id="displayRent">0 N$</td>
                            </tr>
                            <tr>
                                <td>Sonstige Einnahmen</td>
                                <td style="text-align: right;" id="displayOther">0 N$</td>
                            </tr>
                            <tr style="background: #e8f5e9; font-weight: bold;">
                                <td><strong>Gesamteinnahmen</strong></td>
                                <td style="text-align: right;"><strong id="totalRevenue">0 N$</strong></td>
                            </tr>
                            <tr>
                                <td colspan="2" style="height: 10px;"></td>
                            </tr>
                            <tr>
                                <td><strong>Betriebskosten</strong></td>
                                <td style="text-align: right;" id="totalCost">0 N$</td>
                            </tr>
                            <tr>
                                <td colspan="2" style="height: 10px; border-bottom: 2px solid #dee2e6;"></td>
                            </tr>
                            <tr style="background: #fff3cd; font-weight: bold; font-size: 1.2em;">
                                <td><strong>EBIT (Prognose)</strong></td>
                                <td style="text-align: right; color: #28a745;"><strong id="ebitAmount">0 N$</strong></td>
                            </tr>
                        </table>
                    </div>

                    <div id="ebitCapControl" style="display: none;">
                        <!-- Wird dynamisch bef√ºllt -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- TAB 2: BONUSBERECHNUNG -->
        <div id="bonus" class="tab-content">
            <div class="main-content">
                <div class="input-section">
                    <h2>‚öôÔ∏è Bonus Parameter</h2>
                    
                    <div class="result-box" style="background: #e3f2fd; border-left: 5px solid #2196F3;">
                        <h4>üíµ Aktueller EBIT</h4>
                        <div style="font-size: 2em; font-weight: bold; color: #1976D2; text-align: center; padding: 10px;" id="ebitDisplayBonus">0 N$</div>
                    </div>
                    
                    <h3 id="ebitStaffelHeading">üìä EBIT Bonus-Staffelung (70% Gewichtung)</h3>

                    <!-- Verwalter-Ansicht: Nur Anzeige der Werte -->
                    <div class="admin-display">
                        <div class="result-box" style="background: #f8f9fa; border-left: 4px solid #4472C4;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Stufe</th>
                                        <th>Bereich</th>
                                        <th>Bonus-Rate</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Stufe 1</strong></td>
                                        <td>0 - 100.000 N$</td>
                                        <td><strong><span id="tier1RateDisplay">8</span>%</strong></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Stufe 2</strong></td>
                                        <td>100.000 - 500.000 N$</td>
                                        <td><strong><span id="tier2RateDisplay">12</span>%</strong></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Stufe 3</strong></td>
                                        <td>500.000 - 2.000.000 N$</td>
                                        <td><strong><span id="tier3RateDisplay">15</span>%</strong></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Stufe 4</strong></td>
                                        <td>√ºber 2.000.000 N$</td>
                                        <td><strong><span id="tier4RateDisplay">20</span>%</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                            <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
                                <strong>EBIT Cap:</strong> <span id="ebitCapDisplay">4,0</span> Mio N$<br>
                                <strong>Gewichtung:</strong> <span id="weightSplitDisplay">EBIT 70% / Produktivit√§t 30%</span>
                            </div>
                            <div style="margin-top: 10px; padding: 8px; background: #fff3cd; border-radius: 5px; font-size: 0.9em; text-align: center;">
                                üîí Diese Werte sind fest und nur im Admin-Modus √§nderbar
                            </div>
                        </div>
                    </div>

                    <!-- Admin-Ansicht: Regler zum Editieren -->
                    <div class="admin-edit">
                        <div class="input-group">
                            <label>Stufe 1 (0-100k): <span class="range-value" id="tier1RateValue">8%</span></label>
                            <input type="range" id="tier1Rate" min="0" max="20" step="0.5" value="8" oninput="updateValue('tier1Rate'); calculate()">
                        </div>

                        <div class="input-group">
                            <label>Stufe 2 (100k-500k): <span class="range-value" id="tier2RateValue">12%</span></label>
                            <input type="range" id="tier2Rate" min="0" max="25" step="0.5" value="12" oninput="updateValue('tier2Rate'); calculate()">
                        </div>

                        <div class="input-group">
                            <label>Stufe 3 (500k-2M): <span class="range-value" id="tier3RateValue">15%</span></label>
                            <input type="range" id="tier3Rate" min="0" max="30" step="0.5" value="15" oninput="updateValue('tier3Rate'); calculate()">
                        </div>

                        <div class="input-group">
                            <label>Stufe 4 (2M+): <span class="range-value" id="tier4RateValue">20%</span></label>
                            <input type="range" id="tier4Rate" min="0" max="35" step="0.5" value="20" oninput="updateValue('tier4Rate'); calculate()">
                        </div>

                        <div class="input-group">
                            <label>EBIT Cap (Mio N$): <span class="range-value" id="ebitCapValue">4.0M</span></label>
                            <input type="range" id="ebitCap" min="1" max="10" step="0.5" value="4" oninput="updateValue('ebitCap'); calculate()">
                        </div>

                        <div class="input-group">
                            <label>Gewichtung EBIT-Bonus: <span class="range-value" id="ebitWeightValue">70%</span>
                                <span class="tooltip">?
                                    <span class="tooltiptext">Bestimmt die Aufteilung des Bonus zwischen EBIT-S√§ule und Produktivit√§ts-S√§ule. H√∂herer EBIT-Anteil = Fokus auf Gewinn. H√∂herer Produktivit√§ts-Anteil = Fokus auf Effizienz.</span>
                                </span>
                            </label>
                            <input type="range" id="ebitWeight" min="0" max="100" step="5" value="70" oninput="updateValue('ebitWeight'); calculate()">
                            <div style="text-align: center; margin-top: 10px; padding: 8px; background: #e3f2fd; border-radius: 5px; font-size: 0.9em;">
                                <strong>Split:</strong> <span id="weightSplit">EBIT 70% / Produktivit√§t 30%</span>
                            </div>
                        </div>
                    </div>

                    <h3 id="prodIndexHeading">üìä Produktivit√§tsindex (30% Gewichtung)</h3>
                    
                    <div class="result-box" style="background: #fff3e0; border-left: 5px solid #ff9800;">
                        <h4>üìà Automatische Berechnung</h4>
                        <div style="padding: 10px; background: white; border-radius: 5px; margin-top: 10px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <div>
                                    <div style="font-size: 0.9em; color: #6c757d;">kg Schlachtgewicht verkauft</div>
                                    <div style="font-size: 1.2em; font-weight: bold; color: #ff9800;" id="totalKgSold">0 kg</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.9em; color: #6c757d;">Gesamtkosten</div>
                                    <div style="font-size: 1.2em; font-weight: bold; color: #ff9800;" id="totalCostsProd">0 N$</div>
                                </div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #fff3e0; border-radius: 5px;">
                                <div style="font-size: 0.9em; color: #6c757d; margin-bottom: 5px;">Produktivit√§tsindex</div>
                                <div style="font-size: 2em; font-weight: bold; color: #ff6f00;" id="prodIndexValue">0.0</div>
                                <div style="font-size: 0.85em; color: #6c757d; margin-top: 5px;">kg pro 1.000 N$ Kosten</div>
                            </div>
                            <div style="margin-top: 10px; padding: 10px; background: #fff3e0; border-radius: 5px; text-align: center;">
                                <div style="font-size: 0.9em; color: #6c757d;">Bewertung</div>
                                <div style="font-size: 1.1em; font-weight: bold; color: #ff6f00;" id="prodRating">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="result-box">
                        <h4>‚ÑπÔ∏è Richtwerte Farm:</h4>
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Wert</th>
                                    <th>Bewertung</th>
                                    <th>Faktor</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="background: #ffebee;">
                                    <td>&lt; 15</td>
                                    <td>üî¥ Kritisch</td>
                                    <td><strong>Faktor 0√ó</strong></td>
                                </tr>
                                <tr style="background: #fff9c4;">
                                    <td>15-20</td>
                                    <td>üü° Ok</td>
                                    <td><strong>Faktor 1,0√ó</strong></td>
                                </tr>
                                <tr style="background: #e8f5e9;">
                                    <td>20-25</td>
                                    <td>üü¢ Gut</td>
                                    <td><strong>Faktor 1,5√ó</strong></td>
                                </tr>
                                <tr style="background: #fce4ec;">
                                    <td>&gt; 25</td>
                                    <td>üíó Exzellent</td>
                                    <td><strong>Faktor 2,0√ó</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="admin-only-hide">
                        <h3>üë• Personal</h3>
                        <div class="input-group">
                            <label for="baseSalary">Grundgehalt Verwalter-Familie (N$)
                                <span class="tooltip">?
                                    <span class="tooltiptext">J√§hrliches Festgehalt des Farm-Verwalters/Managers ohne Bonus.</span>
                                </span>
                            </label>
                            <input type="text" id="baseSalary" value="700.000" oninput="formatInput(this); calculate()">
                        </div>

                        <h3>üè¶ Auszahlungsstruktur</h3>
                        <div class="input-group">
                            <label>Sofort-Auszahlung: <span class="range-value" id="immediatePaymentValue">60%</span>
                                <span class="tooltip">?
                                    <span class="tooltiptext">Prozentsatz des Bonus, der sofort ausgezahlt wird. Der Rest geht in die 3-Jahres Bonus Bank.</span>
                                </span>
                            </label>
                            <input type="range" id="immediatePayment" min="0" max="100" step="5" value="60" oninput="updateValue('immediatePayment'); calculate()">
                        </div>
                    </div>
                </div>
                
                <div class="output-section">
                    <h2>üí∞ Bonus Ergebnisse</h2>
                    
                    <div class="result-box">
                        <h4>üíé EBIT Bonus - S√§ule 1
                            <span class="tooltip">?
                                <span class="tooltiptext">Progressive Berechnung: Der Bonus wird stufeweise berechnet, √§hnlich wie Einkommenssteuer. Jede EBIT-Stufe wird mit ihrem eigenen Prozentsatz berechnet, dann nach S√§ulengewichtung verrechnet.</span>
                            </span>
                        </h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>Stufe</th>
                                    <th>EBIT Betrag</th>
                                    <th>Rate</th>
                                    <th>Bonus</th>
                                </tr>
                            </thead>
                            <tbody id="ebitBreakdown">
                            </tbody>
                        </table>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #dee2e6;">
                            <table>
                                <tr style="background: #f0f8ff;">
                                    <td><strong>EBIT Bonus Total (ungewichtet)</strong></td>
                                    <td style="text-align: right;"><strong id="ebitBonusRaw">0 N$</strong></td>
                                </tr>
                                <tr style="background: #e3f2fd; font-weight: bold;">
                                    <td><strong id="ebitBonusLabel">EBIT Bonus (70% gewichtet)</strong></td>
                                    <td style="text-align: right;"><strong id="ebitBonus">0 N$</strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <div class="result-box">
                        <h4>üìä Produktivit√§tsbonus - S√§ule 2</h4>
                        <div style="margin-bottom: 15px; padding: 15px; background: #fff3e0; border-radius: 5px;">
                            <table style="width: 100%;">
                                <tr>
                                    <td>Produktivit√§tsindex</td>
                                    <td style="text-align: right;"><strong id="prodIndexDisplay">0.0</strong></td>
                                </tr>
                                <tr>
                                    <td>Bewertung</td>
                                    <td style="text-align: right;" id="prodRatingDisplay">-</td>
                                </tr>
                                <tr>
                                    <td>Bonus-Faktor</td>
                                    <td style="text-align: right;"><strong id="prodFactorDisplay">0.0x</strong></td>
                                </tr>
                            </table>
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #dee2e6;">
                            <table>
                                <tr style="background: #f0f8ff;">
                                    <td><strong>EBIT Bonus Total (ungewichtet)</strong></td>
                                    <td style="text-align: right;"><strong id="ebitBonusRawProd">0 N$</strong></td>
                                </tr>
                                <tr>
                                    <td id="prodBasisLabel">30% Basis (bei Faktor 1,0)</td>
                                    <td style="text-align: right;" id="prodBonusBase">0 N$</td>
                                </tr>
                                <tr>
                                    <td>√ó Produktivit√§ts-Faktor</td>
                                    <td style="text-align: right;" id="prodFactorCalc">√ó 0.0</td>
                                </tr>
                                <tr style="background: #e3f2fd; font-weight: bold;">
                                    <td><strong id="prodBonusLabel">Produktivit√§tsbonus (gewichtet)</strong></td>
                                    <td style="text-align: right;"><strong id="prodBonus">0 N$</strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <div class="highlight-box">
                        <h4>üí∞ GESAMTBONUS</h4>
                        <div class="total-bonus" id="totalBonus">0 N$</div>
                        <div class="percentage admin-only-hide" id="bonusPercentage">0% vom Grundgehalt</div>
                        <hr style="margin: 15px 0; border: none; border-top: 1px solid rgba(255,255,255,0.3);">
                        <div class="result-grid">
                            <div>
                                <div style="opacity: 0.9; font-size: 0.9em;">Sofort-Auszahlung</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="immediateAmount">0 N$</div>
                            </div>
                            <div>
                                <div style="opacity: 0.9; font-size: 0.9em;">Bonus Bank (3 Jahre)</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="bankAmount">0 N$</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="statusMessage" class="success">
                        <strong>‚úÖ Status:</strong> Bonus-Berechnung aktualisiert
                    </div>
                </div>
            </div>
        </div>
        
        <!-- TAB 3: BONUS DETAILANSICHT -->
        <div id="overview" class="tab-content">
            <div style="padding: 30px;">
                <h2>üìä Bonus Detailansicht</h2>

                <div class="result-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                    <h4 style="color: white;">üí° Aktuelle Situation</h4>
                    <div class="stats-grid" style="margin-top: 15px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                            <div style="opacity: 0.9; font-size: 0.9em;">Aktueller EBIT</div>
                            <div style="font-size: 1.8em; font-weight: bold;" id="overviewCurrentEbit">0 N$</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                            <div style="opacity: 0.9; font-size: 0.9em;">Produktivit√§tsindex</div>
                            <div style="font-size: 1.8em; font-weight: bold;" id="overviewProdIndex">0.0</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                            <div style="opacity: 0.9; font-size: 0.9em;">Aktueller Bonus</div>
                            <div style="font-size: 1.8em; font-weight: bold;" id="overviewCurrentBonus">0 N$</div>
                        </div>
                    </div>
                </div>

                <div class="result-box">
                    <h4>üíé S√§ule 1: EBIT Bonus - Progressive Berechnung</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Stufe</th>
                                <th>Bereich</th>
                                <th>Rate</th>
                                <th>Dein EBIT in Stufe</th>
                                <th>Bonus aus Stufe</th>
                                <th>% ausgesch√∂pft</th>
                            </tr>
                        </thead>
                        <tbody id="progressiveBreakdown">
                            <!-- Wird dynamisch bef√ºllt -->
                        </tbody>
                    </table>
                </div>

                <div class="result-box">
                    <h4>üìä S√§ule 2: Produktivit√§tsindex - Kategorie-Einteilung</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Kategorie</th>
                                <th>Index-Bereich</th>
                                <th>Faktor</th>
                                <th>Dein Wert</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="prodCategoryBreakdown">
                            <!-- Wird dynamisch bef√ºllt -->
                        </tbody>
                    </table>
                    <div id="prodIndexExplanation" style="margin-top: 15px; padding: 15px; background: #fff3e0; border-radius: 8px;">
                        <!-- Wird dynamisch bef√ºllt -->
                    </div>
                </div>

                <div class="result-box">
                    <h4>üí∞ Auszahlungsstruktur</h4>
                    <table>
                        <tbody>
                            <tr style="background: #e3f2fd; font-weight: bold; font-size: 1.1em;">
                                <td><strong>Gesamtbonus</strong></td>
                                <td style="text-align: right;"><strong id="overviewTotalBonus">0 N$</strong></td>
                            </tr>
                            <tr style="background: #e8f5e9;">
                                <td>‚Üí Sofort-Auszahlung (<span id="overviewImmediatePercent">60</span>%)</td>
                                <td style="text-align: right;"><strong id="overviewImmediate">0 N$</strong></td>
                            </tr>
                            <tr style="background: #fff3e0;">
                                <td>‚Üí Bonus Bank (<span id="overviewBankPercent">40</span>%) - 3 Jahre Sperrfrist</td>
                                <td style="text-align: right;"><strong id="overviewBank">0 N$</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB 4: INFO & HILFE -->
        <div id="info" class="tab-content">
            <div style="padding: 30px; display: flex; flex-direction: column; gap: 20px;">

                <div class="result-box" style="background: #fffbea; border-left: 5px solid #ffa726; box-shadow: 0 3px 10px rgba(255,167,38,0.2);">
                    <h2 style="color: #e65100; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #ffe0b2;">‚ÑπÔ∏è INFO</h2>

                    <h4 style="color: #e65100; margin-bottom: 8px;">Warum dieses Bonussystem?</h4>
                    <p style="line-height: 1.6; text-align: justify; margin-bottom: 12px; color: #333;">
                        Die F√ºhrung einer Rinderfarm in Namibia erfordert Entscheidungen mit langfristigen Auswirkungen. Welche Tiere werden verkauft? Wie wird die Zuchtbasis entwickelt? Wie werden Kosten optimiert? Diese Fragen pr√§gen den Erfolg der Farm √ºber Jahre.
                    </p>
                    <p style="line-height: 1.6; text-align: justify; margin-bottom: 12px; color: #333;">
                        Das Problem traditioneller Bonussysteme liegt im falschen Anreiz. Ein rein gewinnbasierter Bonus k√∂nnte dazu verleiten, durch massive Verk√§ufe kurzfristig hohe Einnahmen zu erzielen und dabei die Herdenst√§rke zu zerst√∂ren. Die Farm w√ºrde ausgeblutet statt aufgebaut.
                    </p>

                    <h4 style="color: #e65100; margin-top: 15px; margin-bottom: 8px;">Die L√∂sung: Zwei S√§ulen plus Langfristsicherung</h4>
                    <p style="line-height: 1.6; text-align: justify; margin-bottom: 8px; color: #333;">
                        Das System kombiniert drei Komponenten mit klar definierten Zielen.
                    </p>
                    <p style="line-height: 1.6; text-align: justify; margin-bottom: 8px; color: #333;">
                        <strong>Der EBIT-Bonus</strong> als erste S√§ule belohnt wirtschaftlichen Erfolg durch progressive Beteiligung am Betriebsergebnis. Eine Staffelung in vier Stufen honoriert h√∂here Gewinne st√§rker, w√§hrend eine Deckelung extreme Boni verhindert.
                    </p>
                    <p style="line-height: 1.6; text-align: justify; margin-bottom: 8px; color: #333;">
                        <strong>Der Produktivit√§tsbonus</strong> als zweite S√§ule misst die Effizienz der Bewirtschaftung. Der Index zeigt, wie viel Fleisch pro eingesetztem Kapital produziert wird. Ein Verwalter kann diesen Wert nicht durch blo√üen Massenverkauf steigern, sondern nur durch optimiertes Management und nachhaltige Herdenf√ºhrung. Diese Komponente verhindert Raubbau.
                    </p>
                    <p style="line-height: 1.6; text-align: justify; margin: 0; color: #333;">
                        <strong>Die Bonus-Bank</strong> sichert langfristiges Denken ab und federt schwierige Jahre ab. Ein Teil jedes Jahresbonus wird f√ºr mehrere Jahre zur√ºckgehalten. In guten Jahren baut sich ein Puffer auf, aus dem in schwierigen Jahren wie etwa einem D√ºrrejahr ausgezahlt werden kann, selbst wenn kein neuer Bonus entsteht. Wer nachhaltig wirtschaftet, wird auch in harten Zeiten honoriert. Wer jedoch durch kurzsichtige Entscheidungen die Farm sch√§digt, riskiert sowohl k√ºnftige Boni als auch die Auszahlung zur√ºckgehaltener Betr√§ge.
                    </p>
                </div>

                <div class="result-box">
                    <h4>üß≠ System auf einen Blick</h4>
                    <table>
                        <thead>
                            <tr><th>Baustein</th><th>Was z√§hlt?</th><th>Gewichtung</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>EBIT-Bonus</strong></td>
                                <td>Progressive Staffel (0‚Äì100k √ó 8 %, 100‚Äì500k √ó 12 %, 500k‚Äì2 M √ó 15 %, >2 M √ó 20 %), Cap standardm√§√üig 4 Mio N$.</td>
                                <td>70 %</td>
                            </tr>
                            <tr>
                                <td><strong>Produktivit√§tsbonus</strong></td>
                                <td>Index = (kg verkauft √∑ Kosten) √ó 1.000 ‚Üí Faktor 0 / 1,0 / 1,5 / 2,0; Basis ist 30 % des ungewichteten EBIT-Bonus.</td>
                                <td>30 %</td>
                            </tr>
                            <tr>
                                <td><strong>Auszahlung</strong></td>
                                <td>Slider steuert Sofort-Anteil (Standard 60 %); Rest wandert in die Bonus Bank (3 Jahre, Verzinsung laut Firmenvorgabe).</td>
                                <td>‚Äî</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h2 style="color: #2E75B6; margin-top: 30px; margin-bottom: 20px; padding-bottom: 10px; padding-top: 20px; border-top: 3px solid #dee2e6; border-bottom: 2px solid #2E75B6;">üõ†Ô∏è HILFE</h2>

                <div class="result-box">
                    <h4>üìñ Begriffserkl√§rungen</h4>
                    <table>
                        <tbody>
                            <tr><td style="width: 30%;"><strong>Progressiv</strong></td><td>Stufenweise Steigerung statt linearer Prozentsatz. Belohnt Spitzenleistung √ºberproportional, h√§lt Kosten bei schwacher Performance niedrig.</td></tr>
                            <tr><td><strong>EBIT</strong></td><td>Earnings Before Interest and Taxes. Gewinn vor Zinsen und Steuern. Misst operative Profitabilit√§t. Berechnung: Gesamteinnahmen - Betriebskosten.</td></tr>
                            <tr><td><strong>Schlachtgewicht</strong></td><td>Gewicht nach Schlachtung ohne Kopf, Haut, Innereien, Blut. Bei Rindern ca. 55-62% des Lebendgewichts. Dies ist das verkaufbare Fleischgewicht.</td></tr>
                            <tr><td><strong>Herdengr√∂√üe</strong></td><td>Gesamtzahl aller Rinder auf der Farm.</td></tr>
                            <tr><td><strong>Verkaufsrate</strong></td><td>Prozentsatz der Herde, der j√§hrlich verkauft wird.</td></tr>
                            <tr><td><strong>Betriebskosten</strong></td><td>Alle laufenden Farmkosten: Personal, Futter, Veterin√§r, Instandhaltung, Wasser, Energie.</td></tr>
                            <tr><td><strong>Zusatzeinnahmen</strong></td><td>Jagd = Lizenzen, Pacht = Landverpachtung, Sonstiges = Felle, Nebenprodukte.</td></tr>
                            <tr><td><strong>Produktivit√§tsindex</strong></td><td>(kg Schlachtgewicht √∑ Gesamtkosten) √ó 1.000. Misst Effizienz: Fleischoutput pro eingesetztem Kapital.</td></tr>
                            <tr><td><strong>Bonusfaktor</strong></td><td>Multiplikator basierend auf Produktivit√§tsindex. Bestimmt H√∂he des Produktivit√§tsbonus.</td></tr>
                            <tr><td><strong>Bonus-Bank</strong></td><td>Teil des Bonus wird mehrere Jahre zur√ºckgehalten und verzinst. Puffer f√ºr schwierige Jahre.</td></tr>
                            <tr><td><strong>EBIT Cap</strong></td><td>Obergrenze f√ºr die EBIT-Bonusberechnung. Verhindert extreme Bonuszahlungen.</td></tr>
                            <tr><td><strong>Ungewichtet</strong></td><td>Rohbonus aus progressiver Berechnung vor S√§ulenaufteilung.</td></tr>
                            <tr><td><strong>Gewichtet</strong></td><td>Nach S√§ulengewichtung verrechnet.</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="result-box">
                    <h4>üîç Transparenz & Controlling</h4>
                    <table>
                        <tbody>
                            <tr><td style="width: 25%;"><strong>Kosten</strong></td><td>Werden via Kontoausz√ºge und Budgets vom Direktorium kontrolliert und transparent aufbereitet.</td></tr>
                            <tr><td><strong>Herde</strong></td><td>Wird via Airtable mit Daten aus der Farmsoftware monatlich gef√ºttert. Vom Direktorium gef√ºhrt und transparent zur Verf√ºgung gestellt.</td></tr>
                            <tr><td><strong>Weidezustandsindex</strong></td><td>In Planung (TBD).</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="result-box">
                    <h4>üíæ JSON Export & Import</h4>
                    <p style="margin-bottom: 10px; line-height: 1.6;">
                        <strong>Export:</strong> Speichert alle aktuellen Einstellungen (Herdendaten, Bonus-Parameter, etc.) als JSON-Datei auf Ihrem Computer.
                        Perfekt um verschiedene Szenarien zu vergleichen (z.B. "Konservativ", "Optimistisch", "Worst Case").
                    </p>
                    <p style="margin: 0; line-height: 1.6;">
                        <strong>Import:</strong> L√§dt eine zuvor exportierte JSON-Datei und √ºberschreibt alle aktuellen Einstellungen.
                        So k√∂nnen Sie gespeicherte Szenarien jederzeit wiederherstellen oder zwischen verschiedenen Berechnungen wechseln.
                    </p>
                </div>

                <div class="result-box">
                    <h4>üßæ Bedienhinweise</h4>
                    <ul style="margin: 0; padding-left: 18px; line-height: 1.6;">
                        <li>Alle Eingaben werden automatisch im Browser gespeichert (Auto-Save).</li>
                        <li>PDF-Export erstellt einen Bericht mit allen Berechnungen.</li>
                        <li>Admin-Modus nur f√ºr Parameter-Anpassungen durch Direktoren.</li>
                    </ul>
                </div>

            </div>
        </div>
    </div>

    <script>
        // ===== Admin Mode Management =====
        let isAdminMode = false;
        const ADMIN_PASSWORD = 'farm2025'; // √Ñndern Sie dieses Passwort!

        function toggleAdminMode() {
            if (!isAdminMode) {
                // Passwort abfragen
                const password = prompt('Bitte geben Sie das Admin-Passwort ein:');
                if (password === ADMIN_PASSWORD) {
                    isAdminMode = true;
                    enableAdminMode();
                } else if (password !== null) {
                    alert('‚ùå Falsches Passwort!');
                }
            } else {
                // Admin-Modus deaktivieren
                isAdminMode = false;
                disableAdminMode();
            }
        }

        function enableAdminMode() {
            document.getElementById('adminToggle').textContent = 'üîì Admin-Modus aktiv';
            document.getElementById('adminToggle').classList.add('active');

            // Admin-only-hide Sektionen anzeigen (Personal, Auszahlung, Prozent)
            document.querySelectorAll('.admin-only-hide').forEach(section => {
                section.style.display = 'block';
            });

            // Wechsel von Display zu Edit Mode f√ºr Bonus-Parameter
            document.querySelectorAll('.admin-display').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.admin-edit').forEach(el => el.style.display = 'block');

            alert('‚úÖ Admin-Modus aktiviert! Alle Parameter sind jetzt sichtbar und editierbar.');
        }

        function disableAdminMode() {
            document.getElementById('adminToggle').textContent = 'üîí Admin-Modus';
            document.getElementById('adminToggle').classList.remove('active');

            // Admin-only-hide Sektionen verstecken (Personal, Auszahlung, Prozent)
            document.querySelectorAll('.admin-only-hide').forEach(section => {
                section.style.display = 'none';
            });

            // Wechsel von Edit zu Display Mode f√ºr Bonus-Parameter
            document.querySelectorAll('.admin-edit').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.admin-display').forEach(el => el.style.display = 'block');

            alert('üîí Admin-Modus deaktiviert. Sensible Parameter sind versteckt.');
        }

        // ===== LocalStorage Functions =====
        function saveToLocalStorage() {
            const data = {
                herdSize: document.getElementById('herdSize').value,
                slaughterWeight: document.getElementById('slaughterWeight').value,
                salesRate: document.getElementById('salesRate').value,
                pricePerKg: document.getElementById('pricePerKg').value,
                huntingRevenue: document.getElementById('huntingRevenue').value,
                rentRevenue: document.getElementById('rentRevenue').value,
                otherRevenue: document.getElementById('otherRevenue').value,
                baseCosts: document.getElementById('baseCosts').value,
                tier1Rate: document.getElementById('tier1Rate').value,
                tier2Rate: document.getElementById('tier2Rate').value,
                tier3Rate: document.getElementById('tier3Rate').value,
                tier4Rate: document.getElementById('tier4Rate').value,
                ebitCap: document.getElementById('ebitCap').value,
                ebitWeight: document.getElementById('ebitWeight').value,
                baseSalary: document.getElementById('baseSalary').value,
                immediatePayment: document.getElementById('immediatePayment').value,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('farmBonusData', JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('farmBonusData');
            if (savedData) {
                const data = JSON.parse(savedData);
                // Restore all values
                Object.keys(data).forEach(key => {
                    if (key !== 'timestamp') {
                        const element = document.getElementById(key);
                        if (element) {
                            element.value = data[key];
                            if (element.type === 'range') {
                                updateValue(key);
                            }
                        }
                    }
                });
                return true;
            }
            return false;
        }

        // ===== JSON Export/Import Functions =====
        function exportToJSON() {
            const data = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                parameters: {
                    herdSize: document.getElementById('herdSize').value,
                    slaughterWeight: document.getElementById('slaughterWeight').value,
                    salesRate: document.getElementById('salesRate').value,
                    pricePerKg: document.getElementById('pricePerKg').value,
                    huntingRevenue: document.getElementById('huntingRevenue').value,
                    rentRevenue: document.getElementById('rentRevenue').value,
                    otherRevenue: document.getElementById('otherRevenue').value,
                    baseCosts: document.getElementById('baseCosts').value,
                    tier1Rate: document.getElementById('tier1Rate').value,
                    tier2Rate: document.getElementById('tier2Rate').value,
                    tier3Rate: document.getElementById('tier3Rate').value,
                    tier4Rate: document.getElementById('tier4Rate').value,
                    ebitCap: document.getElementById('ebitCap').value,
                    ebitWeight: document.getElementById('ebitWeight').value,
                    baseSalary: document.getElementById('baseSalary').value,
                    immediatePayment: document.getElementById('immediatePayment').value
                }
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `farm-bonus-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.parameters) {
                        Object.keys(data.parameters).forEach(key => {
                            const element = document.getElementById(key);
                            if (element) {
                                element.value = data.parameters[key];
                                if (element.type === 'range') {
                                    updateValue(key);
                                }
                            }
                        });
                        calculate();
                        alert('‚úÖ Daten erfolgreich importiert!');
                    }
                } catch (error) {
                    alert('‚ùå Fehler beim Importieren: ' + error.message);
                }
            };
            reader.readAsText(file);
            // Reset file input
            event.target.value = '';
        }

        // ===== PDF Export Function =====
        function parseDisplayValue(element) {
            // Parse displayed value by removing currency, spaces, and dots (German format)
            const text = element.textContent || element.innerText || '0';
            return parseFloat(text.replace(/[^\d,.-]/g, '').replace(/\./g, '').replace(',', '.')) || 0;
        }

        async function exportToPDF() {
            alert('PDF-Export wird vorbereitet... Dies kann einen Moment dauern.');
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');

            // Get current values
            const herdSize = parseFloat(document.getElementById('herdSize').value);
            const slaughterWeight = parseFloat(document.getElementById('slaughterWeight').value);
            const salesRate = parseFloat(document.getElementById('salesRate').value);
            const pricePerKg = parseFloat(document.getElementById('pricePerKg').value);
            const soldAnimals = Math.round(herdSize * salesRate / 100);
            const totalWeight = soldAnimals * slaughterWeight;
            const cattleRevenue = totalWeight * pricePerKg;
            const huntingRevenue = parseInput(document.getElementById('huntingRevenue'));
            const rentRevenue = parseInput(document.getElementById('rentRevenue'));
            const otherRevenue = parseInput(document.getElementById('otherRevenue'));
            const baseCosts = parseInput(document.getElementById('baseCosts'));
            const totalRevenue = cattleRevenue + huntingRevenue + rentRevenue + otherRevenue;
            const ebit = totalRevenue - baseCosts;
            const totalBonus = parseDisplayValue(document.getElementById('totalBonus'));
            const baseSalary = parseInput(document.getElementById('baseSalary'));
            const bonusPercentage = (totalBonus / baseSalary * 100).toFixed(1);
            const productivityIndex = (baseCosts > 0) ? (totalWeight / baseCosts) * 1000 : 0;

            // Get EBIT breakdown
            const ebitBonusResult = calculateEbitBonus(ebit);
            const ebitBonusRaw = ebitBonusResult.total;
            const ebitBonusWeighted = ebitBonusRaw * 0.7;

            let prodRating = "";
            let prodFactor = 0;
            if (baseCosts <= 0) {
                prodRating = "Nicht berechenbar";
                prodFactor = 0;
            } else if (productivityIndex < 15) {
                prodRating = "Kritisch";
                prodFactor = 0;
            } else if (productivityIndex <= 20) {
                prodRating = "Basis";
                prodFactor = 1.0;
            } else if (productivityIndex <= 25) {
                prodRating = "Gut";
                prodFactor = 1.5;
            } else {
                prodRating = "Exzellent";
                prodFactor = 2.0;
            }

            const prodBonusBase = ebitBonusRaw * 0.3;
            const prodBonus = prodBonusBase * prodFactor;
            const immediateRate = parseFloat(document.getElementById('immediatePayment').value) / 100;
            const immediateAmount = totalBonus * immediateRate;
            const bankAmount = totalBonus * (1 - immediateRate);

            let y = 15;
            const leftMargin = 15;
            const rightMargin = 195;
            const pageWidth = 210;

            // ========== HEADER ==========
            doc.setFillColor(31, 78, 120);
            doc.rect(0, 0, pageWidth, 50, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(28);
            doc.setFont(undefined, 'bold');
            doc.text('FARM BONUSSYSTEM', pageWidth / 2, 20, { align: 'center' });
            doc.setFontSize(14);
            doc.text('Namibia Rinderfarm - Bonus-Bericht', pageWidth / 2, 28, { align: 'center' });
            doc.setFont(undefined, 'normal');
            doc.setFontSize(10);
            doc.text(`Berichtsdatum: ${new Date().toLocaleDateString('de-DE', { year: 'numeric', month: 'long', day: 'numeric' })}`, pageWidth / 2, 36, { align: 'center' });
            doc.text(`Berichtszeit: ${new Date().toLocaleTimeString('de-DE')}`, pageWidth / 2, 43, { align: 'center' });

            y = 60;

            // ========== EXECUTIVE SUMMARY ==========
            doc.setFillColor(102, 126, 234);
            doc.roundedRect(leftMargin, y, rightMargin - leftMargin, 35, 3, 3, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('ZUSAMMENFASSUNG', leftMargin + 5, y + 8);
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`EBIT: ${formatNumber(ebit)} N$`, leftMargin + 5, y + 16);
            doc.text(`Produktivit√§tsindex: ${productivityIndex.toFixed(1)} (${prodRating})`, leftMargin + 5, y + 23);
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(`Gesamtbonus: ${formatNumber(totalBonus)} N$`, leftMargin + 5, y + 31);

            y += 45;

            // ========== SECTION 1: HERDENKENNZAHLEN ==========
            doc.setFillColor(240, 240, 240);
            doc.rect(leftMargin, y, rightMargin - leftMargin, 8, 'F');
            doc.setTextColor(31, 78, 120);
            doc.setFontSize(13);
            doc.setFont(undefined, 'bold');
            doc.text('1. HERDENKENNZAHLEN', leftMargin + 3, y + 6);
            y += 12;

            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');

            // Table
            const herdData = [
                ['Herdengr√∂√üe', `${formatNumber(herdSize)} Tiere`],
                ['Verkaufsrate', `${salesRate}%`],
                ['Verkaufte Tiere', `${formatNumber(soldAnimals)} Tiere`],
                ['√ò Schlachtgewicht', `${formatNumber(slaughterWeight)} kg/Tier`],
                ['Total Schlachtgewicht', `${formatNumber(totalWeight)} kg`],
                ['Preis pro kg', `${formatNumber(pricePerKg)} N$`]
            ];

            herdData.forEach((row, index) => {
                if (index % 2 === 0) {
                    doc.setFillColor(250, 250, 250);
                    doc.rect(leftMargin, y, 180, 6, 'F');
                }
                doc.text(row[0], leftMargin + 3, y + 4.5);
                doc.setFont(undefined, 'bold');
                doc.text(row[1], rightMargin - 3, y + 4.5, { align: 'right' });
                doc.setFont(undefined, 'normal');
                y += 6;
            });

            y += 8;

            // ========== SECTION 2: EBIT BERECHNUNG ==========
            doc.setFillColor(240, 240, 240);
            doc.rect(leftMargin, y, rightMargin - leftMargin, 8, 'F');
            doc.setTextColor(31, 78, 120);
            doc.setFontSize(13);
            doc.setFont(undefined, 'bold');
            doc.text('2. EBIT BERECHNUNG', leftMargin + 3, y + 6);
            y += 12;

            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);

            // Einnahmen
            doc.setFont(undefined, 'bold');
            doc.text('Einnahmen:', leftMargin + 3, y);
            y += 6;
            doc.setFont(undefined, 'normal');

            const revenueData = [
                ['  Viehverkauf', formatNumber(cattleRevenue)],
                ['  Jagd', formatNumber(huntingRevenue)],
                ['  Pacht', formatNumber(rentRevenue)],
                ['  Sonstige', formatNumber(otherRevenue)]
            ];

            revenueData.forEach((row) => {
                doc.text(row[0], leftMargin + 3, y);
                doc.text(`${row[1]} N$`, rightMargin - 3, y, { align: 'right' });
                y += 5;
            });

            doc.setDrawColor(200, 200, 200);
            doc.line(leftMargin, y, rightMargin, y);
            y += 5;

            doc.setFont(undefined, 'bold');
            doc.text('Gesamteinnahmen', leftMargin + 3, y);
            doc.text(`${formatNumber(totalRevenue)} N$`, rightMargin - 3, y, { align: 'right' });
            y += 8;

            // Kosten
            doc.setFont(undefined, 'normal');
            doc.text('Betriebskosten', leftMargin + 3, y);
            doc.text(`${formatNumber(baseCosts)} N$`, rightMargin - 3, y, { align: 'right' });
            y += 6;

            // EBIT Highlight
            doc.setFillColor(212, 237, 218);
            doc.roundedRect(leftMargin, y, rightMargin - leftMargin, 12, 2, 2, 'F');
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(21, 87, 36);
            doc.text('EBIT', leftMargin + 3, y + 8);
            doc.text(`${formatNumber(ebit)} N$`, rightMargin - 3, y + 8, { align: 'right' });
            y += 18;

            // ========== SECTION 3: PRODUKTIVIT√ÑTSINDEX ==========
            doc.setFillColor(240, 240, 240);
            doc.rect(leftMargin, y, rightMargin - leftMargin, 8, 'F');
            doc.setTextColor(31, 78, 120);
            doc.setFontSize(13);
            doc.setFont(undefined, 'bold');
            doc.text('3. PRODUKTIVIT√ÑTSINDEX', leftMargin + 3, y + 6);
            y += 12;

            doc.setFillColor(255, 243, 224);
            doc.roundedRect(leftMargin, y, rightMargin - leftMargin, 20, 2, 2, 'F');
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            doc.text('Formel: (kg Schlachtgewicht √∑ Gesamtkosten) √ó 1.000', leftMargin + 3, y + 6);
            doc.text(`Berechnung: (${formatNumber(totalWeight)} √∑ ${formatNumber(baseCosts)}) √ó 1.000`, leftMargin + 3, y + 12);
            doc.setFont(undefined, 'bold');
            doc.setFontSize(11);
            doc.text(`Index: ${productivityIndex.toFixed(1)}`, leftMargin + 3, y + 18);
            doc.text(`Bewertung: ${prodRating}`, leftMargin + 60, y + 18);
            doc.text(`Faktor: ${prodFactor.toFixed(1)}√ó`, rightMargin - 30, y + 18);
            y += 26;

            // ========== SECTION 4: BONUSBERECHNUNG ==========
            doc.setFillColor(240, 240, 240);
            doc.rect(leftMargin, y, rightMargin - leftMargin, 8, 'F');
            doc.setTextColor(31, 78, 120);
            doc.setFontSize(13);
            doc.setFont(undefined, 'bold');
            doc.text('4. BONUSBERECHNUNG (2-S√ÑULEN-MODELL)', leftMargin + 3, y + 6);
            y += 14;

            // EBIT Bonus Breakdown
            doc.setFontSize(11);
            doc.setTextColor(46, 117, 182);
            doc.setFont(undefined, 'bold');
            doc.text('S√§ule 1: EBIT Bonus (70% Gewichtung)', leftMargin + 3, y);
            y += 6;

            doc.setFontSize(9);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'bold');

            // EBIT Breakdown Table header
            doc.setFillColor(230, 240, 255);
            doc.rect(leftMargin, y, 60, 6, 'F');
            doc.rect(leftMargin + 60, y, 40, 6, 'F');
            doc.rect(leftMargin + 100, y, 25, 6, 'F');
            doc.rect(leftMargin + 125, y, 55, 6, 'F');
            doc.text('Stufe', leftMargin + 2, y + 4);
            doc.text('EBIT Betrag', leftMargin + 62, y + 4);
            doc.text('Rate', leftMargin + 102, y + 4);
            doc.text('Bonus', leftMargin + 127, y + 4);
            y += 6;

            doc.setFont(undefined, 'normal');
            ebitBonusResult.breakdown.forEach((item, index) => {
                if (index % 2 === 0) {
                    doc.setFillColor(250, 250, 250);
                    doc.rect(leftMargin, y, 180, 6, 'F');
                }
                doc.text(item.stufe, leftMargin + 2, y + 4);
                doc.text(formatNumber(item.betrag) + ' N$', leftMargin + 62, y + 4);
                doc.text(item.rate.toFixed(1) + '%', leftMargin + 102, y + 4);
                doc.text(formatNumber(item.bonus) + ' N$', rightMargin - 3, y + 4, { align: 'right' });
                y += 6;
            });

            doc.setFillColor(227, 242, 253);
            doc.rect(leftMargin, y, 180, 7, 'F');
            doc.setFont(undefined, 'bold');
            doc.text('EBIT Bonus Total (ungew.)', leftMargin + 2, y + 5);
            doc.text(formatNumber(ebitBonusRaw) + ' N$', rightMargin - 3, y + 5, { align: 'right' });
            y += 7;

            doc.setFillColor(100, 181, 246);
            doc.setTextColor(255, 255, 255);
            doc.rect(leftMargin, y, 180, 7, 'F');
            doc.text('EBIT Bonus (70% gew.)', leftMargin + 2, y + 5);
            doc.text(formatNumber(ebitBonusWeighted) + ' N$', rightMargin - 3, y + 5, { align: 'right' });
            y += 12;

            // Produktivit√§tsbonus
            doc.setTextColor(46, 117, 182);
            doc.setFontSize(11);
            doc.text('S√§ule 2: Produktivit√§tsbonus (30% Gewichtung)', leftMargin + 3, y);
            y += 6;

            doc.setFontSize(9);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');

            const prodData = [
                ['30% Basis (vom ungew. EBIT Bonus)', formatNumber(prodBonusBase) + ' N$'],
                ['√ó Produktivit√§ts-Faktor', prodFactor.toFixed(1) + '√ó']
            ];

            prodData.forEach((row) => {
                doc.text(row[0], leftMargin + 5, y);
                doc.text(row[1], rightMargin - 3, y, { align: 'right' });
                y += 5;
            });

            doc.setFillColor(100, 181, 246);
            doc.setTextColor(255, 255, 255);
            doc.rect(leftMargin, y, 180, 7, 'F');
            doc.setFont(undefined, 'bold');
            doc.text('Produktivit√§tsbonus (gew.)', leftMargin + 2, y + 5);
            doc.text(formatNumber(prodBonus) + ' N$', rightMargin - 3, y + 5, { align: 'right' });
            y += 12;

            // ========== GESAMTBONUS HIGHLIGHT ==========
            y += 5;
            doc.setFillColor(102, 126, 234);
            doc.roundedRect(leftMargin, y, rightMargin - leftMargin, 25, 3, 3, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('GESAMTBONUS', leftMargin + 5, y + 8);
            doc.setFontSize(20);
            doc.text(`${formatNumber(totalBonus)} N$`, leftMargin + 5, y + 18);
            doc.setFontSize(11);
            doc.text(`${bonusPercentage}% vom Grundgehalt`, rightMargin - 5, y + 18, { align: 'right' });
            y += 30;

            // ========== SECTION 5: AUSZAHLUNGSSTRUKTUR ==========
            doc.setFillColor(240, 240, 240);
            doc.rect(leftMargin, y, rightMargin - leftMargin, 8, 'F');
            doc.setTextColor(31, 78, 120);
            doc.setFontSize(13);
            doc.setFont(undefined, 'bold');
            doc.text('5. AUSZAHLUNGSSTRUKTUR', leftMargin + 3, y + 6);
            y += 12;

            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');

            // Payment boxes
            const paymentBoxWidth = 85;
            const gap = 10;

            // Sofort-Auszahlung
            doc.setFillColor(212, 237, 218);
            doc.roundedRect(leftMargin, y, paymentBoxWidth, 20, 2, 2, 'F');
            doc.setFont(undefined, 'bold');
            doc.text('Sofort-Auszahlung', leftMargin + 3, y + 6);
            doc.setFontSize(14);
            doc.setTextColor(21, 87, 36);
            doc.text(formatNumber(immediateAmount) + ' N$', leftMargin + 3, y + 14);
            doc.setFontSize(9);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            doc.text(`(${(immediateRate * 100).toFixed(0)}%)`, leftMargin + 3, y + 19);

            // Bonus Bank
            doc.setFillColor(255, 243, 224);
            doc.roundedRect(leftMargin + paymentBoxWidth + gap, y, paymentBoxWidth, 20, 2, 2, 'F');
            doc.setFont(undefined, 'bold');
            doc.text('Bonus Bank (3 Jahre)', leftMargin + paymentBoxWidth + gap + 3, y + 6);
            doc.setFontSize(14);
            doc.setTextColor(255, 111, 0);
            doc.text(formatNumber(bankAmount) + ' N$', leftMargin + paymentBoxWidth + gap + 3, y + 14);
            doc.setFontSize(9);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            doc.text(`(${((1 - immediateRate) * 100).toFixed(0)}%)`, leftMargin + paymentBoxWidth + gap + 3, y + 19);

            y += 28;

            // ========== FOOTER ==========
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text('Dieser Bericht wurde automatisch generiert durch das Farm Bonussystem Tool', pageWidth / 2, 285, { align: 'center' });
            doc.text(`¬© ${new Date().getFullYear()} - Vertraulich - Nur f√ºr internen Gebrauch`, pageWidth / 2, 290, { align: 'center' });

            // Save PDF
            doc.save(`farm-bonus-bericht-${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Update overview if switched to it
            if (tabName === 'overview') {
                updateOverview();
            }
        }

        function updateOverview() {
            // Get current calculated values
            const herdSize = parseFloat(document.getElementById('herdSize').value);
            const slaughterWeight = parseFloat(document.getElementById('slaughterWeight').value);
            const salesRate = parseFloat(document.getElementById('salesRate').value) / 100;
            const soldAnimals = Math.round(herdSize * salesRate);
            const totalSlaughterWeight = soldAnimals * slaughterWeight;
            const huntingRevenue = parseInput(document.getElementById('huntingRevenue'));
            const rentRevenue = parseInput(document.getElementById('rentRevenue'));
            const otherRevenue = parseInput(document.getElementById('otherRevenue'));
            const pricePerKg = parseFloat(document.getElementById('pricePerKg').value);
            const cattleRevenue = totalSlaughterWeight * pricePerKg;
            const baseCosts = parseInput(document.getElementById('baseCosts'));
            const totalRevenue = cattleRevenue + huntingRevenue + rentRevenue + otherRevenue;
            const ebit = totalRevenue - baseCosts;
            const productivityIndex = (baseCosts > 0) ? (totalSlaughterWeight / baseCosts) * 1000 : 0;
            const ebitWeightPercent = parseFloat(document.getElementById('ebitWeight').value);
            const totalBonusText = document.getElementById('totalBonus').textContent;
            const immediateRate = parseFloat(document.getElementById('immediatePayment').value) / 100;

            // Update current situation with background color coding
            const ebitBox = document.getElementById('overviewCurrentEbit').parentElement;
            ebitBox.innerHTML = `
                <div style="opacity: 0.9; font-size: 0.9em;">Aktueller EBIT</div>
                <div style="font-size: 1.8em; font-weight: bold;">${formatNumber(ebit)} N$</div>
            `;
            if (ebit < 0) {
                ebitBox.style.background = '#f8d7da';
                ebitBox.querySelector('div:last-child').style.color = '#721c24';
            } else {
                ebitBox.style.background = '#d4edda';
                ebitBox.querySelector('div:last-child').style.color = '#155724';
            }

            const prodBox = document.getElementById('overviewProdIndex').parentElement;
            prodBox.innerHTML = `
                <div style="opacity: 0.9; font-size: 0.9em;">Produktivit√§tsindex</div>
                <div style="font-size: 1.8em; font-weight: bold;">${productivityIndex.toFixed(1)}</div>
            `;
            if (productivityIndex < 15) {
                prodBox.style.background = '#f8d7da';
                prodBox.querySelector('div:last-child').style.color = '#721c24';
            } else if (productivityIndex <= 20) {
                prodBox.style.background = '#fff3cd';
                prodBox.querySelector('div:last-child').style.color = '#856404';
            } else if (productivityIndex <= 25) {
                prodBox.style.background = '#d4edda';
                prodBox.querySelector('div:last-child').style.color = '#155724';
            } else {
                prodBox.style.background = '#fce4ec';
                prodBox.querySelector('div:last-child').style.color = '#c2185b';
            }

            document.getElementById('overviewCurrentBonus').textContent = totalBonusText;

            // Progressive EBIT Breakdown
            const ebitCap = parseFloat(document.getElementById('ebitCap').value) * 1000000;
            const cappedEbit = Math.min(ebit, ebitCap);
            const tier1Rate = parseFloat(document.getElementById('tier1Rate').value) / 100;
            const tier2Rate = parseFloat(document.getElementById('tier2Rate').value) / 100;
            const tier3Rate = parseFloat(document.getElementById('tier3Rate').value) / 100;
            const tier4Rate = parseFloat(document.getElementById('tier4Rate').value) / 100;

            let progressiveHTML = '';
            const tiers = [
                { name: '1', max: 100000, rate: tier1Rate },
                { name: '2', max: 400000, rate: tier2Rate, offset: 100000 },
                { name: '3', max: 1500000, rate: tier3Rate, offset: 500000 },
                { name: '4', max: Infinity, rate: tier4Rate, offset: 2000000 }
            ];

            let cumulativeEbit = 0;
            tiers.forEach((tier, index) => {
                const tierStart = tier.offset || 0;
                const tierSize = tier.max === Infinity ? ebitCap - tierStart : tier.max;
                const yourEbitInTier = Math.max(0, Math.min(cappedEbit - tierStart, tierSize));
                const bonusFromTier = yourEbitInTier * tier.rate;
                const percentUsed = tierSize > 0 ? (yourEbitInTier / tierSize * 100) : 0;

                const tierMax = tier.max === Infinity ? ebitCap : tierStart + tierSize;
                const tierLabel = tier.max === Infinity ? `${formatNumber(tierStart)} - ${formatNumber(ebitCap)} N$` :
                                  `${formatNumber(tierStart)} - ${formatNumber(tierMax)} N$`;

                progressiveHTML += `
                    <tr>
                        <td><strong>${tier.name}</strong></td>
                        <td>${tierLabel}</td>
                        <td>${(tier.rate * 100).toFixed(1)}%</td>
                        <td>${formatNumber(yourEbitInTier)} N$</td>
                        <td><strong>${formatNumber(bonusFromTier)} N$</strong></td>
                        <td>${percentUsed.toFixed(0)}%</td>
                    </tr>
                `;
            });
            document.getElementById('progressiveBreakdown').innerHTML = progressiveHTML;

            // Produktivit√§tsindex Kategorien
            let prodHTML = '';
            const categories = [
                { name: 'üî¥ Kritisch', min: 0, max: 15, factor: 0, bg: '#ffebee' },
                { name: 'üü° Ok', min: 15, max: 20, factor: 1.0, bg: '#fff9c4' },
                { name: 'üü¢ Gut', min: 20, max: 25, factor: 1.5, bg: '#e8f5e9' },
                { name: 'üíó Exzellent', min: 25, max: 999, factor: 2.0, bg: '#fce4ec' }
            ];

            let currentCategory = '';
            categories.forEach(cat => {
                const isInCategory = productivityIndex >= cat.min && productivityIndex < cat.max;
                const rangeText = cat.max === 999 ? `> ${cat.min}` : `${cat.min} - ${cat.max}`;
                const yourValue = isInCategory ? productivityIndex.toFixed(1) : '-';
                const status = isInCategory ? '‚úÖ Ja' : '';

                if (isInCategory) currentCategory = cat.name;

                prodHTML += `
                    <tr style="background: ${cat.bg};">
                        <td>${cat.name}</td>
                        <td>${rangeText}</td>
                        <td><strong>Faktor ${cat.factor.toFixed(1)}√ó</strong></td>
                        <td>${yourValue}</td>
                        <td><strong>${status}</strong></td>
                    </tr>
                `;
            });
            document.getElementById('prodCategoryBreakdown').innerHTML = prodHTML;

            // Produktivit√§tsindex Erkl√§rung
            let explanation = `<strong>Warum in dieser Kategorie:</strong><br>`;
            explanation += `‚Ä¢ Dein Index: ${productivityIndex.toFixed(1)}<br>`;
            explanation += `‚Ä¢ Berechnung: (${formatNumber(totalSlaughterWeight)} kg √∑ ${formatNumber(baseCosts)} N$) √ó 1.000<br>`;
            if (currentCategory) {
                explanation += `‚Ä¢ ‚Üí ${currentCategory}`;
            }
            document.getElementById('prodIndexExplanation').innerHTML = explanation;

            // Auszahlungsstruktur
            const totalBonus = parseFloat(totalBonusText.replace(/[^\d]/g, '')) || 0;
            const immediateAmount = totalBonus * immediateRate;
            const bankAmount = totalBonus * (1 - immediateRate);

            document.getElementById('overviewTotalBonus').textContent = formatNumber(totalBonus) + ' N$';
            document.getElementById('overviewImmediatePercent').textContent = (immediateRate * 100).toFixed(0);
            document.getElementById('overviewImmediate').textContent = formatNumber(immediateAmount) + ' N$';
            document.getElementById('overviewBankPercent').textContent = ((1 - immediateRate) * 100).toFixed(0);
            document.getElementById('overviewBank').textContent = formatNumber(bankAmount) + ' N$';
        }
        
        function formatNumber(num) {
            return Math.round(num).toLocaleString('de-DE');
        }
        
        function formatInput(input) {
            // Get raw number value (remove all dots)
            let value = input.value.replace(/\./g, '');
            
            // Remove non-digits
            value = value.replace(/\D/g, '');
            
            // Convert to number and format with thousand separators
            if (value === '') {
                input.value = '0';
            } else {
                const num = parseInt(value);
                input.value = num.toLocaleString('de-DE');
            }
        }
        
        function parseInput(input) {
            // Parse formatted input back to number
            return parseFloat(input.value.replace(/\./g, '')) || 0;
        }
        
        function updateValue(id) {
            const input = document.getElementById(id);
            const value = parseFloat(input.value);
            const display = document.getElementById(id + 'Value');

            if (id.includes('Rate') || id === 'baseInterest' || id === 'immediatePayment' || id === 'ebitWeight') {
                display.textContent = value + '%';
            } else if (id === 'multiplierMax') {
                display.textContent = value.toFixed(1) + 'x';
            } else if (id === 'ebitCap') {
                display.textContent = value.toFixed(1) + 'M';
            } else if (id === 'investment') {
                display.textContent = formatNumber(value);
            } else {
                display.textContent = formatNumber(value);
            }

            // Update weight split display and headings
            if (id === 'ebitWeight') {
                const prodWeightValue = 100 - value;
                document.getElementById('weightSplit').textContent = `EBIT ${value.toFixed(0)}% / Produktivit√§t ${prodWeightValue.toFixed(0)}%`;
                document.getElementById('weightSplitDisplay').textContent = `EBIT ${value.toFixed(0)}% / Produktivit√§t ${prodWeightValue.toFixed(0)}%`;
                document.getElementById('ebitStaffelHeading').textContent = `üìä EBIT Bonus-Staffelung (${value.toFixed(0)}% Gewichtung)`;
                document.getElementById('prodIndexHeading').textContent = `üìä Produktivit√§tsindex (${prodWeightValue.toFixed(0)}% Gewichtung)`;
            }

            // Update display values for Verwalter view
            if (id === 'tier1Rate') document.getElementById('tier1RateDisplay').textContent = value.toFixed(1);
            if (id === 'tier2Rate') document.getElementById('tier2RateDisplay').textContent = value.toFixed(1);
            if (id === 'tier3Rate') document.getElementById('tier3RateDisplay').textContent = value.toFixed(1);
            if (id === 'tier4Rate') document.getElementById('tier4RateDisplay').textContent = value.toFixed(1);
            if (id === 'ebitCap') document.getElementById('ebitCapDisplay').textContent = value.toFixed(1);
        }
        
        function calculateEbitBonus(ebit) {
            const tier1Rate = parseFloat(document.getElementById('tier1Rate').value) / 100;
            const tier2Rate = parseFloat(document.getElementById('tier2Rate').value) / 100;
            const tier3Rate = parseFloat(document.getElementById('tier3Rate').value) / 100;
            const tier4Rate = parseFloat(document.getElementById('tier4Rate').value) / 100;
            const ebitCap = parseFloat(document.getElementById('ebitCap').value) * 1000000;
            
            const cappedEbit = Math.min(ebit, ebitCap);
            let totalBonus = 0;
            const breakdown = [];
            
            // Stufe 1: 0-100k
            if (cappedEbit > 0) {
                const amount = Math.min(cappedEbit, 100000);
                const bonus = amount * tier1Rate;
                totalBonus += bonus;
                breakdown.push({
                    stufe: 'Stufe 1 (0-100k)',
                    betrag: amount,
                    rate: tier1Rate * 100,
                    bonus: bonus
                });
            }
            
            // Stufe 2: 100k-500k
            if (cappedEbit > 100000) {
                const amount = Math.min(cappedEbit - 100000, 400000);
                const bonus = amount * tier2Rate;
                totalBonus += bonus;
                breakdown.push({
                    stufe: 'Stufe 2 (100k-500k)',
                    betrag: amount,
                    rate: tier2Rate * 100,
                    bonus: bonus
                });
            }
            
            // Stufe 3: 500k-2M
            if (cappedEbit > 500000) {
                const amount = Math.min(cappedEbit - 500000, 1500000);
                const bonus = amount * tier3Rate;
                totalBonus += bonus;
                breakdown.push({
                    stufe: 'Stufe 3 (500k-2M)',
                    betrag: amount,
                    rate: tier3Rate * 100,
                    bonus: bonus
                });
            }
            
            // Stufe 4: 2M-4M
            if (cappedEbit > 2000000) {
                const amount = cappedEbit - 2000000;
                const bonus = amount * tier4Rate;
                totalBonus += bonus;
                breakdown.push({
                    stufe: 'Stufe 4 (2M+)',
                    betrag: amount,
                    rate: tier4Rate * 100,
                    bonus: bonus
                });
            }
            
            return {
                total: totalBonus,
                breakdown: breakdown
            };
        }
        
        function calculate() {
            // Auto-save to localStorage
            saveToLocalStorage();

            // Herdenberechnung
            const herdSize = parseFloat(document.getElementById('herdSize').value);
            const slaughterWeight = parseFloat(document.getElementById('slaughterWeight').value);
            const salesRate = parseFloat(document.getElementById('salesRate').value) / 100;
            const pricePerKg = parseFloat(document.getElementById('pricePerKg').value);
            
            const soldAnimals = Math.round(herdSize * salesRate);
            const totalSlaughterWeight = soldAnimals * slaughterWeight;
            const cattleRevenue = totalSlaughterWeight * pricePerKg;
            
            // Sonstige Einnahmen
            const huntingRevenue = parseInput(document.getElementById('huntingRevenue')) || 0;
            const rentRevenue = parseInput(document.getElementById('rentRevenue')) || 0;
            const otherRevenue = parseInput(document.getElementById('otherRevenue')) || 0;
            const totalRevenue = cattleRevenue + huntingRevenue + rentRevenue + otherRevenue;
            
            // Kosten berechnen (FIXE KOSTEN)
            const baseCosts = parseInput(document.getElementById('baseCosts'));
            const totalCost = baseCosts;
            
            // EBIT
            const ebit = totalRevenue - totalCost;
            
            // Get dynamic weighting
            const ebitWeightPercent = parseFloat(document.getElementById('ebitWeight').value);
            const ebitWeight = ebitWeightPercent / 100;
            const prodWeight = 1 - ebitWeight;

            // Calculate EBIT Bonus (PROGRESSIVE - KORRIGIERT!)
            const ebitBonusResult = calculateEbitBonus(ebit);
            const ebitBonusRaw = ebitBonusResult.total;
            const ebitBonusTotal = ebitBonusRaw * ebitWeight; // Dynamic weighting
            
            // Calculate Productivity Index and Bonus (KORREKT nach PDF!)
            // Formel: (kg Schlachtgewicht verkauft √∑ Gesamtkosten) √ó 1000
            // Protection against division by zero
            const productivityIndex = (totalCost > 0) ? (totalSlaughterWeight / totalCost) * 1000 : 0;

            // Bonus-Faktor basierend auf Index (laut PDF Seite 4)
            let prodBonusFactor = 0;
            let prodRating = "";
            if (totalCost <= 0) {
                prodBonusFactor = 0;
                prodRating = "‚ö†Ô∏è Keine Kosten - nicht berechenbar - Faktor 0√ó";
            } else if (productivityIndex < 15) {
                prodBonusFactor = 0;
                prodRating = "üî¥ Kritisch - Faktor 0√ó";
            } else if (productivityIndex <= 20) {
                prodBonusFactor = 1;
                prodRating = "üü° Ok - Faktor 1,0√ó";
            } else if (productivityIndex <= 25) {
                prodBonusFactor = 1.5;
                prodRating = "üü¢ Gut - Faktor 1,5√ó";
            } else {
                prodBonusFactor = 2;
                prodRating = "üíó Exzellent - Faktor 2,0√ó";
            }
            
            // KORRIGIERTE BERECHNUNG mit dynamischer Gewichtung:
            // Bei Faktor 1,0 ‚Üí prodWeight% vom ungewichteten EBIT-Bonus
            // Bei anderen Faktoren ‚Üí entsprechend skaliert
            const prodBonusBase = ebitBonusRaw * prodWeight; // Dynamic weight vom ungewichteten EBIT-Bonus
            const prodBonusTotal = prodBonusBase * prodBonusFactor; // mal Faktor
            
            // Total Bonus (without Skin in the Game)
            const totalBonus = ebitBonusTotal + prodBonusTotal;
            const baseSalary = parseInput(document.getElementById('baseSalary'));
            const bonusPercentage = (totalBonus / baseSalary * 100) || 0;
            
            // Payment structure
            const immediateRate = parseFloat(document.getElementById('immediatePayment').value) / 100;
            const immediateAmount = totalBonus * immediateRate;
            const bankAmount = totalBonus * (1 - immediateRate);
            
            // Update Herdenkennzahlen
            document.getElementById('displayHerdSize').textContent = formatNumber(herdSize) + ' Tiere';
            document.getElementById('soldAnimals').textContent = formatNumber(soldAnimals);
            document.getElementById('totalWeight').textContent = formatNumber(totalSlaughterWeight) + ' kg';
            document.getElementById('avgWeight').textContent = formatNumber(slaughterWeight) + ' kg';
            
            // Update formula display
            document.getElementById('soldAnimalsDetail').textContent = 
                `${formatNumber(soldAnimals)} √ó ${formatNumber(slaughterWeight)} kg √ó ${formatNumber(pricePerKg)} N$/kg`;
            
            // Update EBIT Berechnung
            document.getElementById('cattleRevenue').textContent = formatNumber(cattleRevenue) + ' N$';
            document.getElementById('displayHunting').textContent = formatNumber(huntingRevenue) + ' N$';
            document.getElementById('displayRent').textContent = formatNumber(rentRevenue) + ' N$';
            document.getElementById('displayOther').textContent = formatNumber(otherRevenue) + ' N$';
            document.getElementById('totalRevenue').textContent = formatNumber(totalRevenue) + ' N$';
            document.getElementById('totalCost').textContent = '- ' + formatNumber(totalCost) + ' N$';

            // EBIT mit Farbcodierung (rot bei negativ)
            const ebitElement = document.getElementById('ebitAmount');
            ebitElement.textContent = formatNumber(ebit) + ' N$';
            ebitElement.style.color = ebit < 0 ? '#dc3545' : '#28a745';

            // EBIT Cap Control
            const ebitCap = parseFloat(document.getElementById('ebitCap').value) * 1000000;
            const ebitCapControl = document.getElementById('ebitCapControl');
            if (ebit > ebitCap) {
                ebitCapControl.style.display = 'block';
                ebitCapControl.className = 'warning';
                ebitCapControl.innerHTML = `<strong>‚ö†Ô∏è EBIT Cap Warnung:</strong> Ihr EBIT (${formatNumber(ebit)} N$) liegt √ºber dem eingestellten Cap (${formatNumber(ebitCap)} N$).
                F√ºr die Bonusberechnung wird nur der Cap-Betrag ber√ºcksichtigt. √úbersch√ºssiger EBIT: ${formatNumber(ebit - ebitCap)} N$.`;
            } else if (ebit > ebitCap * 0.9) {
                ebitCapControl.style.display = 'block';
                ebitCapControl.className = 'info-box';
                ebitCapControl.style.background = '#fff3cd';
                ebitCapControl.style.borderLeft = '4px solid #ffc107';
                ebitCapControl.innerHTML = `<strong>üí° Hinweis:</strong> EBIT n√§hert sich dem Cap (${formatNumber(ebitCap)} N$).
                Noch ${formatNumber(ebitCap - ebit)} N$ bis zum Maximum. Erw√§gen Sie eine Cap-Erh√∂hung falls realistisch.`;
            } else {
                ebitCapControl.style.display = 'none';
            }

            // Update EBIT im Bonus-Tab
            document.getElementById('ebitDisplayBonus').textContent = formatNumber(ebit) + ' N$';
            
            // Update Produktivit√§tsindex Anzeige
            document.getElementById('totalKgSold').textContent = formatNumber(totalSlaughterWeight) + ' kg';
            document.getElementById('totalCostsProd').textContent = formatNumber(totalCost) + ' N$';
            document.getElementById('prodIndexValue').textContent = productivityIndex.toFixed(1);
            document.getElementById('prodRating').textContent = prodRating;
            
            // EBIT Breakdown Table
            let breakdownHTML = '';
            ebitBonusResult.breakdown.forEach(item => {
                breakdownHTML += `
                    <tr>
                        <td>${item.stufe}</td>
                        <td>${formatNumber(item.betrag)} N$</td>
                        <td>${item.rate.toFixed(1)}%</td>
                        <td>${formatNumber(item.bonus)} N$</td>
                    </tr>
                `;
            });
            document.getElementById('ebitBreakdown').innerHTML = breakdownHTML;
            
            document.getElementById('ebitBonusRaw').textContent = formatNumber(ebitBonusRaw) + ' N$';
            document.getElementById('ebitBonus').textContent = formatNumber(ebitBonusTotal) + ' N$';
            document.getElementById('ebitBonusLabel').textContent = `EBIT Bonus (${ebitWeightPercent.toFixed(0)}% gewichtet)`;

            // Update Produktivit√§tsbonus Anzeige (neue Struktur)
            document.getElementById('prodIndexDisplay').textContent = productivityIndex.toFixed(1);
            document.getElementById('prodRatingDisplay').textContent = prodRating;
            document.getElementById('prodFactorDisplay').textContent = prodBonusFactor.toFixed(1) + 'x';
            document.getElementById('ebitBonusRawProd').textContent = formatNumber(ebitBonusRaw) + ' N$';
            document.getElementById('prodBonusBase').textContent = formatNumber(prodBonusBase) + ' N$';
            document.getElementById('prodBasisLabel').textContent = `${(prodWeight * 100).toFixed(0)}% Basis (bei Faktor 1,0)`;
            document.getElementById('prodFactorCalc').textContent = '√ó ' + prodBonusFactor.toFixed(1);
            document.getElementById('prodBonus').textContent = formatNumber(prodBonusTotal) + ' N$';
            document.getElementById('prodBonusLabel').textContent = `Produktivit√§tsbonus (${(prodWeight * 100).toFixed(0)}% gewichtet)`;

            document.getElementById('totalBonus').textContent = formatNumber(totalBonus) + ' N$';
            document.getElementById('bonusPercentage').textContent = bonusPercentage.toFixed(1) + '% vom Grundgehalt';
            document.getElementById('immediateAmount').textContent = formatNumber(immediateAmount) + ' N$';
            document.getElementById('bankAmount').textContent = formatNumber(bankAmount) + ' N$';
            
            // Status message
            const statusDiv = document.getElementById('statusMessage');
            if (ebit < 0) {
                statusDiv.className = 'warning';
                statusDiv.innerHTML = '<strong>‚ö†Ô∏è Warnung:</strong> Die Farm macht Verlust!';
            } else if (ebit < 500000) {
                statusDiv.className = 'warning';
                statusDiv.innerHTML = '<strong>‚ö†Ô∏è Hinweis:</strong> EBIT zu niedrig f√ºr attraktiven Bonus.';
            } else {
                statusDiv.className = 'success';
                statusDiv.innerHTML = '<strong>‚úÖ Gut:</strong> Solide Performance mit fairem Bonus.';
            }
        }
        
        function updateDashboard() {
            const baseSalary = parseInput(document.getElementById('baseSalary'));
            const investment = parseFloat(document.getElementById('investment').value);
            
            // Calculate key statistics
            const bonus1M = calculateEbitBonus(1000000).total * 0.7;
            const bonus2M = calculateEbitBonus(2000000).total * 0.7;
            const maxBonus = calculateEbitBonus(parseFloat(document.getElementById('ebitCap').value) * 1000000).total * 0.7;
            
            document.getElementById('bonus1M').textContent = formatNumber(bonus1M);
            document.getElementById('bonus2M').textContent = formatNumber(bonus2M);
            document.getElementById('maxBonus').textContent = formatNumber(maxBonus);
            
            // Find break-even (extend search to ebitCap)
            const ebitCapValue = parseFloat(document.getElementById('ebitCap').value) * 1000000;
            let breakEven = 0;
            for (let ebit = 0; ebit <= ebitCapValue; ebit += 10000) {
                if (calculateEbitBonus(ebit).total * 0.7 >= baseSalary * 0.01) {
                    breakEven = ebit;
                    break;
                }
            }
            if (breakEven === 0 && calculateEbitBonus(ebitCapValue).total * 0.7 < baseSalary * 0.01) {
                document.getElementById('breakEven').textContent = '> ' + formatNumber(ebitCapValue);
            } else {
                document.getElementById('breakEven').textContent = formatNumber(breakEven);
            }
            
            // Update charts
            updateBonusChart();
            updateComparisonChart();
            updateDetailTable();
        }
        
        function updateBonusChart() {
            const ctx = document.getElementById('bonusChart').getContext('2d');
            const ebitPoints = [];
            const bonusPoints = [];
            
            for (let ebit = 0; ebit <= 5000000; ebit += 250000) {
                ebitPoints.push(ebit);
                bonusPoints.push(calculateEbitBonus(ebit).total * 0.7);
            }
            
            if (bonusChart) {
                bonusChart.destroy();
            }
            
            bonusChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ebitPoints.map(val => formatNumber(val)),
                    datasets: [{
                        label: 'Bonus (N$)',
                        data: bonusPoints,
                        borderColor: 'rgb(68, 114, 196)',
                        backgroundColor: 'rgba(68, 114, 196, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Bonus-Kurve nach EBIT (Progressive Berechnung)',
                            font: { size: 16, weight: 'bold' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Bonus (N$)' },
                            ticks: { callback: value => formatNumber(value) }
                        },
                        x: {
                            title: { display: true, text: 'EBIT (N$)' }
                        }
                    }
                }
            });
        }
        
        function updateComparisonChart() {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            const ebitPoints = [];
            
            for (let ebit = 0; ebit <= 5000000; ebit += 250000) {
                ebitPoints.push(ebit);
            }
            
            const currentBonus = ebitPoints.map(ebit => calculateEbitBonus(ebit).total * 0.7);
            
            // Conservative scenario
            const conservativeBonus = ebitPoints.map(ebit => {
                const tempTiers = [0.05, 0.08, 0.10, 0.12];
                let bonus = 0;
                const cappedEbit = Math.min(ebit, 4000000);
                if (cappedEbit > 0) bonus += Math.min(cappedEbit, 100000) * tempTiers[0];
                if (cappedEbit > 100000) bonus += Math.min(cappedEbit - 100000, 400000) * tempTiers[1];
                if (cappedEbit > 500000) bonus += Math.min(cappedEbit - 500000, 1500000) * tempTiers[2];
                if (cappedEbit > 2000000) bonus += Math.min(cappedEbit - 2000000, 2000000) * tempTiers[3];
                return bonus * 0.7;
            });
            
            // Aggressive scenario
            const aggressiveBonus = ebitPoints.map(ebit => {
                const tempTiers = [0.12, 0.18, 0.22, 0.28];
                let bonus = 0;
                const cappedEbit = Math.min(ebit, 4000000);
                if (cappedEbit > 0) bonus += Math.min(cappedEbit, 100000) * tempTiers[0];
                if (cappedEbit > 100000) bonus += Math.min(cappedEbit - 100000, 400000) * tempTiers[1];
                if (cappedEbit > 500000) bonus += Math.min(cappedEbit - 500000, 1500000) * tempTiers[2];
                if (cappedEbit > 2000000) bonus += Math.min(cappedEbit - 2000000, 2000000) * tempTiers[3];
                return bonus * 0.7;
            });
            
            if (comparisonChart) {
                comparisonChart.destroy();
            }
            
            comparisonChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ebitPoints.map(val => formatNumber(val)),
                    datasets: [{
                        label: 'Aktuelle Einstellung',
                        data: currentBonus,
                        borderColor: 'rgb(68, 114, 196)',
                        borderWidth: 3,
                        fill: false
                    }, {
                        label: 'Konservativ',
                        data: conservativeBonus,
                        borderColor: 'rgb(75, 192, 192)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false
                    }, {
                        label: 'Aggressiv',
                        data: aggressiveBonus,
                        borderColor: 'rgb(255, 99, 132)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Vergleich: Konservativ vs. Aktuell vs. Aggressiv',
                            font: { size: 16, weight: 'bold' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: value => formatNumber(value) }
                        }
                    }
                }
            });
        }
        
        function updateDetailTable() {
            const baseSalary = parseInput(document.getElementById('baseSalary'));
            const tbody = document.getElementById('detailTable');
            const keyPoints = [100000, 250000, 500000, 750000, 1000000, 1500000, 2000000, 2500000, 3000000, 3500000, 4000000];
            
            let html = '';
            keyPoints.forEach(ebit => {
                const bonus = calculateEbitBonus(ebit).total * 0.7;
                const percentage = (bonus / baseSalary * 100).toFixed(1);
                const effectiveRate = (bonus / ebit * 100).toFixed(2);
                
                html += `
                    <tr>
                        <td>${formatNumber(ebit)}</td>
                        <td>${formatNumber(bonus)}</td>
                        <td>${percentage}%</td>
                        <td>${effectiveRate}%</td>
                        <td>-</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Initialize
        window.onload = function() {
            // Try to load from localStorage first
            const loaded = loadFromLocalStorage();

            // Update all range value displays
            ['tier1Rate', 'tier2Rate', 'tier3Rate', 'tier4Rate', 'ebitCap', 'ebitWeight',
             'immediatePayment', 'herdSize', 'slaughterWeight', 'salesRate'].forEach(id => {
                updateValue(id);
            });

            // Calculate with loaded or default values
            calculate();

            if (loaded) {
                console.log('‚úÖ Daten aus LocalStorage geladen');
            }
        };
    </script>
</body>
</html>